## Разработка и публикация приложений 

Краткая инструкция по разработке, отладке и публикации приложений на примере iframe- и серверных приложений.

### Разработка серверных приложений

При разработке серверного приложения следует определиться по следующим вопросам:

* Должен ли будет пользователь настраивать приложение при его установке на аккаунт? Если да - то нужно реализовать 
iframe-часть для серверного приложения, по возможности используя UI Kit МоегоСклада.
 
* Будет ли в iframe-части серверного приложения какой-либо пользовательский функционал, кроме настроек? Если да - то,
 возможно, следует предусмотреть, чтобы пользовательский функционал был доступен не только администратору аккаунта 
 (как, например, настройки), но и другим пользователям аккаунта (всем или с определенными правами). 
 
* Нужны ли дополнительные поля для сущностей и/или документов? Если да - то можно будет их создавать через JSON API 
1.2 в рамках активации приложения. Здесь скорее всего потребуется использовать сценарий асинхронной активации 
(с возвратом статуса Activating).

* Будет ли у приложения виджет? Если да - то нужно реализовать iframe-часть и 
для виджета тоже.

Также заметим, что для серверных приложений является обязательным реализация эндпоинта /api/moysklad/vendor/1.0/apps 
(см. [Vendor API](https://dev.moysklad.ru/doc/api/vendor/1.0/)) на стороне вендора, и предполагается, что 
серверное приложение будет взаимодействовать с МоимСкладом по JSON API 1.2 с авторизацией по токену (передаваемому 
приложению по Vendor API при активации).

### Разработка iframe-приложений

При разработке iframe-приложения вендору следует определиться по следующим вопросам:

* Насколько будет использоваться [UI Kit МоегоСклада](https://github.com/moysklad/html-marketplace-1.0-uikit) для 
построения пользовательского интерфейса содержимого iframe? Приветствуется использование UI Kit МоегоСклада.

### Личный кабинет вендора 

Для упрощения и автоматизации работы над приложениями Маркетплейса был создан **Личный кабинет вендора** (ЛКВ). Это сервис, 
который позволяет вендорам самостоятельно создавать приложения в статусе _Draft_ (_Черновик_), 
отлаживать и тестировать их на витрине приложений, вносить необходимые изменения (в том числе самостоятельно получать и 
изменять SecretKey) и, по окончании разработки, отправлять на модерацию в МойСклад. 

Что можно делать в личном кабинете:
 
- Создавать Черновики приложений 
- Редактировать Черновики приложений и просматривать информацию о приложениях в прочих статусах
- Редактировать информацию о разработчике 
- Отправлять Черновики приложений на модерацию
- Следить за статусами публикации своих приложений
- Предоставлять и продлевать пробный период для платных приложений 
- Привязывать аккаунты в МоемСкладе к аккаунту в Личном кабинете для отладки неопубликованных приложений
- Просматривать отчеты по установкам и выручке
- Просматривать, скачивать и согласовывать отчет об использовании приложений
    
#### Получение доступа к личному кабинету Вендора

Для получения доступа в Личный кабинет заполните, пожалуйста, 
<a href="https://partners.moysklad.ru/developers/#register" target="_blank">анкету</a>. 
Мы пришлем вам доступ и дальнейшие инструкции на указанный в анкете email в течение пары дней.

#### Создание черновика приложения

Форма создания черновика приложения открывается по кнопке **Создать приложение**.  

В первую очередь предлагается заполнить **Псевдоним приложения**. Псевдоним - уникальный идентификатор, поэтому невозможно
создать два приложения с одинаковыми псевдонимами.

В личном кабинете Вендора можно завести следующие **типы приложений**:

 - Серверное приложение
 - Телефонию
 - Интеграцию с системами лояльности
 - Iframe-приложение
 
<u>Создание Серверных и Iframe-приложений:</u>
 
При создании Серверного или Iframe приложения можно указать [платным или бесплатным](#platnye-i-besplatnye-prilozheniq)
будет ваше приложение: за это отвечает чекбокс **Платное**.

Для платных приложений нужно определить их стоимость, кратную 500 рублям. Максимальная стоимость приложения, которую можно
задать через ЛКВ, 10000 рублей, минимальная, соответственно, 500 рублей. Если необходимо указать большую стоимость, вендор
может обратиться к сотруднику МоегоСклада.

Для платных приложений открывается возможность добавить [Пробный период](#probnyj-period-platnyh-prilozhenij). 
После установки отметки в чекбоксе **Платное** станет доступен селектор, в котором можно выбрать длительность Пробного периода 
(до 14 дней) или его отсутствие.

При создании Серверного или Iframe-приложения дескриптор обязателен для заполнения. Ознакомиться с правилами его заполнения
можно в разделе [Дескриптор приложения](#deskriptor-prilozheniq).

<u>Создание Телефонии:</u>

При создании приложения с типом Телефония нельзя проставить признак Платности, выбрать Пробный период и не нужно заполнять
Дескриптор. Телефония оплачивается пользователем отдельно - через опцию CRM.

<u>Создание Интеграции с системами лояльности:</u>

При создании приложения Лояльности нельзя проставить признак Платности, выбрать Пробный период и не нужно заполнять
Дескриптор.

#### Редактирование черновика приложения

После того, как приложение было создано, может потребоваться что-то в нем изменить.
Для этого необходимо выбрать его в списке приложений и нажать кнопку **Редактировать приложение**.

**Что следует знать:**

- **Редактировать можно только приложения в статусе Черновик**.
    - **После передачи на модерацию** можно будет просматривать данные приложения (нажав на кнопку **Редактировать 
    приложение**), но внести изменения не получится. Возможность редактирования снова появится, если приложение будет 
    возвращено на доработку модератором.
    - **После публикации** приложения изменения могут быть внесены только модератором МоегоСклада по запросу
- **В форме редактирования доступны те же поля, что и в форме создания.** К ним применимо все перечисленное в разделе "Создание черновика приложения" 
- **Доступны просмотр и перегенерация [Секретного ключа](#sekretnyj-kluch-secretkey)**. 
    - Для просмотра следует нажать на кнопку-глаз у скрытого точками поля, для генерации нового ключа - кнопку **Сгенерировать**.
    - кнопка **Сгенерировать**, как и прочие изменения приложения, доступна только для Черновиков
- Также в форме редактирования отображаются read-only поля с техническими параметрами и статусом публикации приложения

#### Отправка на модерацию

Перед публикацией на витрине МоегоСклада новое приложение должно сначала пройти модерацию.

Для отправки на модерацию следует выбрать нужное приложение в статусе Черновик из списка и нажать кнопку **Отправить на модерацию**.

**Важно:** для получения оперативных оповещений о ходе модерации необходимо заполнить **Email для уведомлений** в разделе 
**Вендор**

#### Ручная приостановка приложения 

Возможности Личного кабинета позволяют разработчику тестировать и, при необходимости, отлаживать приложения при приостановке и 
возобновлении на аккаунте.

Для тестирования приостановки необходимо:

1. Привязать аккаунт в МоемСкладе к аккаунту Вендора в ЛКВ (создать аккаунт разработчика)
1. Завести **платное** приложение в ЛКВ
1. Установить приложение на аккаунте разработчика
1. Выбрать приложение в списке и нажать кнопку **Приостановить на аккаунте**
1. Готово! Приложение приостановлено.
1. Для отладки возобновления можно воспользоваться кнопкой **Активировать** в карточке приложения на витрине МоегоСклада.

Приостановка возможна только для приложений, которые уже установлены или устанавливаются. 

#### Продление пробного периода платного приложения

В Личном кабинете доступна возможность единоразово [продлить пробный период](#prodlenie-probnogo-perioda) на выбранном аккаунте для платного опубликованного приложения. 
Для этого необходимо:

1. В Списке приложений выбрать платное опубликованное приложение.
1. Нажать на кнопку **Предоставить пробный период**.
1. В окне **Предоставление пробного периода** заполнить поля **Аккаунт** и **Количество дней**. 
1. При отсутствии ошибок откроется окно **Подтверждение пробного периода**. 
1. Нужно проверить предоставляемый пробный период и нажать на кнопку **Да, предоставить**. 

#### Редактирование информации о вендоре

Для редактирования информации о вендоре (разработчике) приложения потребуется перейти на вкладку **Вендор** в верхнем 
меню Личного кабинета.

Функция доступна, пока на аккаунте отсутствуют приложения или есть только Черновики. В остальных случаях данные доступны 
только для просмотра, а для изменения следует обратиться к модератору МоегоСклада.

Также есть возможность внести или отредактировать реквизиты для выплат денежных средств вендору. 
Для этого потребуется перейти на вкладку **Реквизиты** в верхнем меню.

#### Привязка аккаунта к вендору

Отладка приложений для Маркетплейса производится на аккаунтах разработчика. Для того, чтобы аккаунт в МоемСкладе стал 
аккаунтом разработчика, его нужно **привязать к вендору**, и это тоже можно сделать в Личном кабинете вендора.

Инициировать привязку можно по кнопке **Привязать**, расположенной в верхнем меню Личного кабинета.

**Важно:** Для привязки необходимо иметь доступ к email ответственного сотрудника, назначенного в аккаунте МоегоСклада на странице 
Подписка. По умолчанию им является администратор, зарегистрировавший аккаунт, однако впоследствии этого пользователя можно изменить.

Изменить уже существующую привязку можно путем нажатия на имя текущей привязки. Предыдущая привязка будет удалена,
а установленные на отвязанном аккаунте приложения в статусах Черновик (Draft) и Готово,
отправлено на модерацию (Ready) деинсталлированы.

#### Сводный отчет по установкам приложений

В данном отчете можно посмотреть сколько активных установок есть у приложений, сколько из них пробных и оплачиваемых. Также можно посмотреть сколько приостановленных установок.

Для просмотра отчета по установкам необходимо перейти в раздел **Отчеты** в верхнем меню выбрать вкладку **Установки**.

В отчет включаются:

 - Все приложения независимо от платности и наличия установок
 - В статусе Опубликовано и Снято с публикации.

#### Отчет по выручке платных приложений

Данный отчет предоставляет информацию по тому сколько приложение заработало денежных средств. Учитываются только реально оплачиваемые установки. Установки на Пробном тарифе и с Пробным периодом приложений не учитываются.

Для просмотра отчета по выручке необходимо в разделе **Отчеты** верхнего меню выбрать вкладку **Выручка**.

В отчет включаются:

  - Приложения во всех [статусах](https://dev.moysklad.ru/doc/api/vendor/1.0/#zhiznennyj-cikl-prilozheniq) 
  - Платные приложения, у которых есть хотя бы 1 успешная установка
  - Бесплатные приложения, если ранее они были платными с успешными установками.

#### Отчет об использовании приложений

Отчет об использовании приложений является основанием для выплаты вендору денежных средств за использование приложения пользователями МоегоСклада.

Для просмотра и согласования отчета необходимо в разделе **Отчеты** верхнего меню выбрать вкладку **Выплаты**.

Отчет формируется раз в месяц, доступен для скачивания в виде PDF-файла. Содержит информацию сколько денег заработало каждое приложение в отдельности и все приложения вендора вместе за месяц.

**Что важно знать:** 

1. Для формирования отчета должны быть заполнены реквизиты.
1. Вендору поступает отчет в статусе Сформировано (на почту приходит оповещение).
1. Вендор ознакамливается с отчетом и согласовывает его – кнопка Согласовать.
1. Статус отчета меняется на Согласовано.
1. Выплачивается вознаграждение согласно банковским реквизитам вендора и проставляется отметка Выплачено.

Если вендор имеет возражения по отчету, то он его не согласовывает и обращается к сотруднику МоегоСклада.

### Карточка вендора

Карточка вендора - это Google Sheets таблицы, через которые происходил обмен информацией между вендором и 
МоимСкладом до создания Личного кабинета.

На данный момент карточка не используется.

### Отладка приложений на аккаунтах разработчика

Отладка неопубликованных приложений выполняется вендором на специальном аккаунте(ах), привязанных к вендору. 

На таких аккаунтах неопубликованные приложения вендора появляются в специальном блоке на витрине приложений 
"ПРИЛОЖЕНИЯ В РАЗРАБОТКЕ". Для остальных пользователей приложения-черновики не будут видны. 

Неопубликованные приложения можно подключать и отключать так же, как и обычные опубликованные приложения.

Привязка аккаунтов к вендору осуществляется через [Личный кабинет вендора](#lichnyj-kabinet-wendora).  

### Общая схема процесса размещения приложения в Маркетплейсе

После готовности приложения на стороне вендора в общем случае вендору нужно выполнить следующие шаги по размещению 
приложения в Маркетплейсе:

1. Создать Черновик приложения в Личном кабинете вендора.
2. После создания Черновика на странице редактирования приложения будет доступен [Секретный ключ](#sekretnyj-kluch-secretkey) (Secret Key).
3. Создать [аккаунт разработчика](#otladka-prilozhenij-na-akkauntah-razrabotchika), привязав [аккаунт 
МоегоСклада](https://online.moysklad.ru/) к аккаунту в [Личном кабинете вендора](#lichnyj-kabinet-wendora).
4. Протестировать и отладить приложение на аккаунте разработчика.
5. Отправить приложение на модерацию через Личный кабинет вендора.

Далее сотрудник МоегоСклада смотрит на приложение и, при отсутствии замечаний, публикует его на витрине приложений.


### Демо-приложение

Для демонстрации взаимодействия приложений с Маркетплейсом МоегоСклада было создано демо-приложение на PHP.

В демо-приложении реализованы следующие функции:

* Активация (с получением токена доступа к JSON API 1.2) и деактивация по Vendor API.
* Использование iframe для настройки приложения администратором аккаунта с обновлением статуса в Маркетплейсе.
* Получение контекста пользователя для iframe (отображение информации по пользователю, проверка прав администратора).
* Получение информации из МоегоСклада по JSON API 1.2 с доступом по токену.

Более подробную информацию и исходный код приложения можно получить по ссылке: [https://github.com/moysklad/php-dummyapp-marketplace-1.0](https://github.com/moysklad/php-dummyapp-marketplace-1.0)
