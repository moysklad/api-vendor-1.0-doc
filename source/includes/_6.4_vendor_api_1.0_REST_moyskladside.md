### REST-эндпоинты на стороне МоегоСклада 

Rest-эндпоинты на стороне МоегоСклада позволяют разработчику ограниченно управлять состоянием установки приложения для конкретного аккаунта и получать информацию о пользователе, который работает с приложением в UI МоегоСклада.
 
Базовый URL REST-эндпоинтов со стороны МоегоСклада (далее — `MARKETPLACE-ENDPOINT`):

[https://apps-api.moysklad.ru/api/vendor/1.0](https://apps-api.moysklad.ru/api/vendor/1.0)

При запросах к API обязательно нужно указать в HTTP-заголовке запроса **Accept-Encoding** формат сжатия содержимого — **gzip**. Если указан другой формат, возвращается ошибка 415 Unsupported Media Type (Неподдерживаемый тип данных).

На текущий момент со стороны МоегоСклада есть следующие эндпоинты:

+ [Получение статуса приложения на аккаунте](#poluchenie-statusa-prilozheniq-na-akkaunte)
+ [Изменение статуса приложения на аккаунте](#izmenenie-statusa-prilozheniq-na-akkaunte)
+ [Получение контекста пользователя для приложений с iframe-частью, кастомными модальными окнами и виджетами](#poluchenie-kontexta-pol-zowatelq-dlq-prilozhenij-s-iframe-chast-u-kastomnymi-modal-nymi-oknami-i-widzhetami)

#### Получение статуса приложения на аккаунте

С помощью этого вызова разработчик может получить текущий статус установки приложения на аккаунте пользователя.

**Resource**: `MARKETPLACE-ENDPOINT/apps/{appId}/{accountId}/status`

Здесь:

+ **appId** `UUID` — идентификатор приложения в МоемСкладе;
+ **accountId** `UUID` — идентификатор аккаунта в МоемСкладе.

<u>HTTP-метод</u>: **GET**

<u>Тело запроса</u>: **отсутствует**

<u>Тело ответа</u>:

В случае успешного ответа возвращается текущий статус приложения на аккаунте со следующими атрибутами:

| Название	     | Тип    | Описание                              | Обязательное при ответе |
|:--------------|:-------|:--------------------------------------|:------------------------|
| status        | String | Текущий статус приложения на аккаунте | Да                      |
| cause         | String | Причина перехода в текущий статус     | Нет                     |
| subscription  | Object | Параметры текущей подписки            | Нет                     |

##### Атрибуты сущности subscription

| Название	    | Тип     | Описание                                                                                    | Обязательное при ответе |
|:-------------|:--------|:--------------------------------------------------------------------------------------------|:------------------------|
| tariffId     | UUID    | Идентификатор тарифа, на котором приобретена подписка                                       | Да                      |
| trial        | Boolean | Признак пробной подписки                                                                    | Да                      |
| tariffName   | String  | Название тарифа                                                                             | Нет                     |
| expiryMoment | String  | Дата окончания подписки в формате [RFC 3339](https://datatracker.ietf.org/doc/html/rfc3339) | Нет                     |
| notForResale | Boolean | Признак того, что аккаунт, установивший приложение, является аккаунтом партнера МоегоСклада | Да                      |

Если приложение не подключено на данном аккаунте или указанный аккаунт отсутствует в МоемСкладе, возвращается ошибка 404 Not Found (код 2004).

##### Таблица возможных статусов приложения на аккаунте

| status             | cause     | Значение                                                                                               |
|:-------------------|:----------|:-------------------------------------------------------------------------------------------------------|
| Activating         | Install   | Приложение в процессе установки на аккаунт                                                             |
| ActivationFailed   | Install   | Произошла ошибка при установке приложения на аккаунт                                                   |                                                     
| SettingsRequired   |           | Приложение успешно установлено на акканут, для полноценной работы требуется настройка пользователя     |
| Activated          |           | Приложение активно на аккаунте (успешно установлено на аккаунт и, если нужно, настроено пользователем) |
| Deactivating       | Uninstall | Приложение в процессе удаления с аккаунта                                                              |           
| DeactivationFailed | Uninstall | Произошла ошибка при удалении приложения с аккаунта                                                    |                
| Deactivating       | Suspend   | Приложение в процессе приостановки на аккаунте                                                         |       
| DeactivationFailed | Suspend   | Произошла ошибка во время приостановки приложения на аккаунте                                          |            
| Suspended          |           | Приложение приостановлено на аккаунте                                                                  |
| Activating         | Resume    | Приложение в процессе возобновления работы на аккаунте                                                 |      
| ActivationFailed   | Resume    | Произошла ошибка во время возобновления работы приложения на аккаунте                                  |           

<u>HTTP status codes:</u>

+ **200 OK** — все в порядке, в ответе отдается состояние приложения.
+ **404 Not Found** — приложение не подключено на данном аккаунте (код 2004).

> Пример запроса на получение статуса приложения на аккаунте

```shell
curl "https://apps-api.moysklad.ru/api/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f/status"     
-H "Accept: application/json"     
-H "Authorization: Bearer ..."  
```

> ---
> Response 200 (application/json).
> Успешный запрос.

```json
{
  "status": "Activated",
  "cause": "Install",
  "subscription": {
    "tariffId": "23ca69d4-2657-40c4-8ba1-6ce24ddeac2e",
    "trial": false,
    "tariffName": "Basic",
    "expiryMoment": "2024-01-19T18:50:12+03:00",
    "notForResale": false
  }
}
```

#### Изменение статуса приложения на аккаунте

С помощью <b>PUT</b> запроса разработчик может изменить статус устанавливающегося приложения пользователя. При [активации 
приложения со стороны разработчика](#rest-andpointy-na-storone-razrabotchika-prilozhenij), разработчик может ответить одним из статусов **Activated**, 
**Activating**, **SettingsRequired**. Если разработчик перевел в статусы **Activating** и **SettingsRequired**, то МойСклад ожидает, что 
разработчик с помощью обратного вызова оповестит МойСклад о том, что активация на его стороне завершена.

**Resource**: `MARKETPLACE-ENDPOINT/apps/{appId}/{accountId}/status`

Здесь:

+ **appId** `UUID` — идентификатор приложения в МоемСкладе;
+ **accountId** `UUID` — идентификатор аккаунта в МоемСкладе.

<u>HTTP-метод</u>: **PUT**

<u>Тело запроса</u>:

+ **status** `String` — текущий актуальный статус приложения. Возможные значения: **Activating**, **SettingsRequired**, **Activated**.


При обработке данного запроса МойСклад проверяет возможность перехода приложения на аккаунте в требуемое состояние в 
соответствии с жизненным циклом приложения на аккаунте. При отсутствии перехода по жизненному циклу — ошибка. 
Если приложение на аккаунте уже находится в целевом состоянии, то ошибки нет.

<u>Тело ответа</u>: пустое (за исключением ошибок)

<u>HTTP status codes</u>:

+ **200 OK** — МойСклад перевел приложение на аккаунте в соответствующее переданному статусу состояние или приложение 
уже находилось в требуемом состоянии.
+ **404 Not Found** — приложение не подключено на данном аккаунте.
+ **409 Conflict** — в случае отсутствия соответствующего перехода по жизненному циклу приложения на аккаунте.

> Пример запроса на изменение статуса приложения на аккаунте

```shell
curl -X PUT "https://apps-api.moysklad.ru/api/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f/status"     
-H "Content-Type: application/json"
-H "Accept: application/json"    
-H "Authorization: Bearer ..."  
-d '{
      "status": "Activating"
    }'
```

> ---

> Response 200 (application/json).
> Успешный запрос.

#### Изменение настроек лояльности на аккаунте

С помощью этого запроса разработчик может изменить настройки программы лояльности у аккаунта пользователя.
Запрос доступен для статусов жизненного цикла приложения **SettingsRequired** и **Installed** и
только для приложений, у которых есть блок **loyaltyApi** в дескрипторе.

**Resource**: `MARKETPLACE-ENDPOINT/apps/{appId}/{accountId}/loyalty`

Здесь:

+ **appId** `UUID` — идентификатор приложения в МоемСкладе;
+ **accountId** `UUID` — идентификатор аккаунта в МоемСкладе.

<u>HTTP-метод</u>: **PUT**

<u>Тело запроса</u>:

+ **url** `String` — адрес программы лояльности;

+ **token** `String` — токен доступа к программе лояльности;
  
+ **externalSearch** `Boolean` — флаг поиска покупателей во внешней системе.

<u>Тело ответа</u>: пустое (за исключением ошибок)

<u>HTTP status codes</u>:

+ **200 OK** — Настройки успешно сохранены.
+ **404 Not Found** — приложение не подключено на данном аккаунте.
+ **400 Bad Request** — в случае отсутствия loyaltyApi в дескрипторе приложения или нахождения приложения в статусе
  отличном от **SettingsRequired** и **Installed**.

Подробнее про работу с системами лояльности см. [документацию LoyaltyAPI](https://dev.moysklad.ru/doc/api/loyalty/1.0/)

> Пример запроса на изменение настроек лояльности приложения на аккаунте

```shell
curl -X PUT "https://apps-api.moysklad.ru/api/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f/loyalty"     
-H "Content-Type: application/json"
-H "Accept: application/json"    
-H "Authorization: Bearer ..."  
-d '{
    "url": "https://...",
    "token": "...",
    "externalSearch": true
}'
```

> ---

> Response 200 (application/json).
> Успешный запрос.

#### Получение контекста пользователя для приложений с iframe-частью, кастомными модальными окнами и виджетами

Через этот эндпоинт можно получить информацию о пользователе, который использует приложение в UI МоегоСклада. 
Для получения контекста пользователя в URL, по которому загружается основной iframe, модальное окно или виджет, добавляется GET-параметр **contextKey**. 

Пример того, что будет загружаться в iframe, при условии, что в [дескрипторе приложения](#deskriptor-prilozheniq)
`sourceUrl` имеет значение `https://yoursite.ru/moysklad`:

 `https://yoursite.ru/moysklad?contextKey=1c14e98cd272239c03bf3d9697f167699743292c`.

**contextKey** — это временный ключ, который может быть использован в течение 5 минут с момента загрузки iframe для получения контекста пользователя через данный эндпоинт. Если был использован **contextKey**, после окончания времени его жизни эндпоинт вернет ошибку `404 Not Found`.

**Resource**: `MARKETPLACE-ENDPOINT/context/{contextKey}`

Здесь:

+ **contextKey** `String` — ключ, переданный ранее GET-параметром при загрузке iframe.

<u>HTTP-метод</u>: **POST**

<u>Тело запроса</u>: пустое

<u>Тело ответа</u>:

В случае успешного ответа возвращается такое же по структуре содержимое как в 
[эндпоинте получения Контекста сотрудника JSON API](https://dev.moysklad.ru/doc/api/remap/1.2/#mojsklad-json-api-obschie-swedeniq-kontext-zaprosa-sotrudnika):

`https://api.moysklad.ru/api/remap/1.2/context/employee`.

В случае ошибок возвращается JSON-объект с ошибкой. Подробнее см. [Обработка ошибок МоегоСклада](#obrabotka-oshibok-na-storone-moegosklada).

<u>HTTP status codes</u>:

+ **200 OK** — все в порядке, в ответе отдается контекст пользователя;
+ **403 Forbidden** — приложение не авторизовано на доступ по данному contextKey;
+ **404 Not Found** — contextKey не найден или истекло время его жизни.

> Пример запроса на получение контекста пользователя

```shell
curl -X POST "https://apps-api.moysklad.ru/api/vendor/1.0/context/6S3BQLsaSRNdEnhPCoW9lplY2LozRUOq6S3BQLsaSRNdEnh"     
-H "Accept: application/json"     
-H "Authorization: Bearer ..."  
```

> ---

> Response 200 (application/json).
  Успешный запрос.

```json
{
  "meta": {
    "href": "https://api.moysklad.ru/api/remap/1.2/entity/employee/b0a02321-13e3-11e9-912f-f3d4002516e3?expand=cashier.retailStore",
    "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/employee/metadata",
    "type": "employee",
    "mediaType": "application/json",
    "uuidHref": "https://online.moysklad.ru/app/#employee/edit?id=b0a02321-13e3-11e9-912f-f3d4002516e3"
  },
  "id": "b0a02321-13e3-11e9-912f-f3d4002516e3",
  "accountId": "b0b309ee-13e3-11e9-9109-f8fc0001f188",
  "owner": {
    "meta": {
      "href": "https://api.moysklad.ru/api/remap/1.2/entity/employee/b0a02321-13e3-11e9-912f-f3d4002516e3",
      "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/employee/metadata",
      "type": "employee",
      "mediaType": "application/json",
      "uuidHref": "https://online.moysklad.ru/app/#employee/edit?id=b0a02321-13e3-11e9-912f-f3d4002516e3"
    }
  },
  "shared": true,
  "group": {
    "meta": {
      "href": "https://api.moysklad.ru/api/remap/1.2/entity/group/b0b3c289-13e3-11e9-9109-f8fc0001f189",
      "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/group/metadata",
      "type": "group",
      "mediaType": "application/json"
    }
  },
  "updated": "2019-12-10 18:37:25.786",
  "name": "Кожевников",
  "externalCode": "Exh56G1wiRTPHpYBc-nx12",
  "archived": false,
  "created": "2019-01-09 10:53:45.202",
  "uid": "admin@bkozhevnikov",
  "email": "bkozhevnikov@moysklad.ru",
  "lastName": "Кожевников",
  "fullName": "Кожевников",
  "shortFio": "Кожевников",
  "cashiers": [
    {
      "meta": {
        "href": "https://api.moysklad.ru/api/remap/1.2/entity/retailstore/b0b7cd8d-13e3-11e9-912f-f3d400251724/cashiers/b0b7d387-13e3-11e9-912f-f3d400251725",
        "type": "cashier",
        "mediaType": "application/json"
      }
    }
  ],
  "permissions": {
    "currency": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "uom": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "productfolder": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "product": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "bundle": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "service": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "consignment": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "variant": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "store": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "counterparty": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "organization": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "employee": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "contract": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "project": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "country": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "customentity": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "demand": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "customerorder": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "internalorder": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "invoiceout": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "invoicein": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "paymentin": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "paymentout": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "cashin": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "cashout": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "supply": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "salesreturn": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "purchasereturn": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "retailstore": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "receipttemplate": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "retailshift": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "retaildemand": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "retailsalesreturn": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "retaildrawercashin": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "retaildrawercashout": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "prepayment": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "prepaymentreturn": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "purchaseorder": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "move": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "enter": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "loss": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "facturein": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "factureout": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "commissionreportin": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "commissionreportout": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "pricelist": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "processingplanfolder": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "processingplan": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "processing": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "processingorder": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "assortment": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "inventory": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "print": "ALL"
    },
    "bonustransaction": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "crptorder": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "approve": "ALL",
      "print": "ALL"
    },
    "webhook": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL"
    },
    "task": {
      "view": "ALL",
      "create": "ALL",
      "update": "ALL",
      "delete": "ALL",
      "done": "ALL"
    },
    "dashboard": {
      "view": "ALL"
    },
    "stock": {
      "view": "ALL"
    },
    "customAttributes": {
      "view": "ALL"
    },
    "pnl": {
      "view": "ALL"
    },
    "company_crm": {
      "view": "ALL"
    },
    "tariff_crm": {
      "view": "ALL"
    },
    "audit_dashboard": {
      "view": "ALL"
    },
    "admin": {
      "view": "ALL"
    },
    "dashboardMoney": {
      "view": "ALL"
    }
  }
}
```

#### Обработка ошибок на стороне МоегоСклада

При взаимодействии Разработчик → МойСклад обработка ошибок на стороне МоегоСклада выполняется аналогично тому, как это сделано в [JSON API 1.2 ](https://dev.moysklad.ru/doc/api/remap/1.2/). В тело ответа включается JSON-объект с описанием ошибки. При необходимости в ответе проставляются соответствующие HTTP-заголовки.


