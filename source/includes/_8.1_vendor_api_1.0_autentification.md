## Vendor API 1.0

Vendor API предназначено для взаимодействия Маркетплейса с системами вендоров касательно процессов, происходящих в 
рамках функционирования Маркетплейса.

На текущий момент Vendor API включает в себя следующие функции:

+ Активацию и деактивацию приложений на аккаунте
+ Получение контекста пользователя приложения

В данном разделе описаны спецификации REST-эндпоинтов на стороне МоегоСклада и вендора приложений.

### Аутентификация взаимодействия по Vendor API

Все запросы от МоегоСклада к серверу вендора и в обратную сторону от сервера вендора к МоемуСкладу должны быть 
подписаны с использованием JWT (JSON Web Token) описанным ниже образом.

#### Секретный ключ secretKey

Если приложение предполагает взаимодействие по Vendor API (оповещение по активации и деактивации, получение 
контекста пользователя для iframe), то ему понадобится Секретный ключ.

Секретный ключ (secretKey) используется для построения/вычисления сигнатуры JWT.

Секретный ключ генерируется на стороне МоегоСклада и выдается вендору. На текущий момент процесс выглядит так:

1. Вендор заводит Черновик приложения в [Личном кабинете вендора](#lichnyj-kabinet-wendora).
2. После этого будет доступна страница редактирования, на которой, в числе прочих read-only полей, доступен Секретный ключ.
3. Пока приложение находится в статусе Черновик, вендор может перегенерировать Секретный ключ самостоятельно.
4. После передачи приложения на модерацию и далее Секретный ключ доступен только для просмотра и копирования.
3. Если по какой-то причине вендор хочет перегенерировать secretKey для приложения не в статусе Черновик, то он это 
делает через взаимодействие с сотрудником МоегоСклада.

#### Исходящие запросы МойСклад → Вендор

МойСклад подписывает свои запросы к [REST-эндпоинтам вендора](#rest-andpointy-na-storone-wendora-prilozhenij), передавая JWT-токен в заголовке HTTP-запроса следующим образом:

Authorization: `Bearer <token> `


Описание полей JWT-payload:

|Поле|Описание|Предполагаемое использование вендором|
|---|---|---|
|iat|Время генерации токена в секундах от 1970-01-01T00:00:00Z UTC|На усмотрение вендора|
|exp|Время жизни/“протухания“ токена в секундах от 1970-01-01T00:00:00Z UTC - позволяет ограничить срок валидности токена (после указанного момента времени токен считается невалидным)|При получении JWT после времени, указанного в exp, следует отклонять запрос с ошибкой аутентификации |
|jti|Уникальный идентификатор токена - позволяет отслеживать одноразовость применения токена|При получении JWT с jti, который был уже получен ранее, следует отклонять запрос с ошибкой аутентификации|

```text
JWT-header всегда такой:
```

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

```text
JWT-payload включает в себя следующие поля:
```

```json
{
  "iat": 1516239022,
  "exp": 1516239322,
  "jti": "6S3BQLsaSRNdEnhPCoW9lplY2LozRUOq"
}
```

#### Входящие запросы Вендор → МойСклад

Вендор при выполнении [REST запросов к МоемуСкладу по Vendor API](#rest-andpointy-na-storone-moegosklada) также должен подписывать их токеном JWT, который также 
следует передавать в заголовке HTTP-запроса:

Authorization: `Bearer <token>`

Поле alg в JWT-заголовке всегда должно иметь значение HS256. Соответственно, JWT-сигнатура всегда должна генерироваться 
по алгоритму HMAC SHA-256 с использованием секретного ключа secretKey.


Описание полей JWT-payload:

|Поле|Обязательное|Описание|Обработка на стороне МоегоСклада|
|---|-------|--------|--------------------------|
|sub|да|appUid приложения|Используется для идентификации и авторизации приложения|
|iat|да|Время генерации токена в секундах от 1970-01-01T00:00:00Z UTC|Используется для ограничения допустимого времени жизни токена| 
|exp|нет|Время жизни/“протухания“ токена в секундах от 1970-01-01T00:00:00Z UTC (после какого момента токен считается невалидным)|Если данное поле присутствует, то оно также используется для проверки валидности токена по времени|
|jti|да|Уникальный идентификатор токена|Используется для проверки одноразовости использования токена|

В системе МоегоСклада есть ограничение на максимальное время жизни для JWT-токена (порядка нескольких минут) - 
назовем его maxTokenLifetime. При проверке/валидации на стороне МоегоСклада значение exp ограничивается максимальным 
временем жизни: если _(exp - iat)_ превышает maxTokenLifetime или поле exp отсутствует, то в качестве exp 
используется _iat + maxTokenLifetime_, то есть:

**effectiveExp = exp ? min(exp, iat + maxTokenLifetime) : iat + maxTokenLifetime**

```text
JWT-header может быть как с указанием поля typ:
```

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

```text
так и без поля typ:
```

```json
{
  "alg": "HS256"
}
```

```text
JWT-payload должен содержать следующие поля (все поля являются обязательными за исключением exp - это поле опциональное):
```


```json
{
  "sub": "dummyapp.example-vendor",
  "iat": 1516239022,
  "exp": 1516239322,
  "jti": "6S3BQLsaSRNdEnhPCoW9lplY2LozRUOq"
}
```

#### Ошибки аутентификации и авторизации

Обработка ошибок аутентификации и авторизации на стороне МоегоСклада осуществляется аналогично тому 
как это сделано в JSON API 1.2:

[https://dev.moysklad.ru/doc/api/remap/1.2/](https://dev.moysklad.ru/doc/api/remap/1.2/)

То есть при возникновении ошибок возвращается аналогичный объект error и заголовки HTTP-ответа X-Lognex-Auth 
и X-Lognex-Auth-Message.

