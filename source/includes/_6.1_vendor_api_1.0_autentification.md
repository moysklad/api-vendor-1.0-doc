## Vendor API 1.0

Системы разработчиков взаимодействуют с каталогом решений МоегоСклада через Vendor API.

Функции Vendor API:

+ Активация и деактивация решений на аккаунте.
+ Получение контекста пользователя решения.

Далее приводятся спецификации REST-эндпоинтов на стороне МоегоСклада и разработчика решений.

### Аутентификация взаимодействия по Vendor API

Все запросы от МоегоСклада к серверу разработчика и от сервера разработчика к МоемуСкладу должны быть подписаны с
использованием JWT (JSON Web Token) описанным ниже образом.

#### Секретный ключ secretKey

Если решение предполагает взаимодействие по Vendor API — оповещение по активации и деактивации, получение контекста
пользователя для iframe, решению необходим Секретный ключ.

Секретный ключ (secretKey) используется для построения или вычисления сигнатуры JWT.

Секретный ключ генерируется на стороне МоегоСклада и выдается разработчику:

1. Разработчику необходимо завести Черновик решения в [личном кабинете разработчика](#lichnyj-kabinet-razrabotchika).
   После этого открывается доступ к странице редактирования.
2. На странице редактирования в числе полей, доступных для просмотра (read-only), доступен Секретный ключ.
3. Пока решение находится в статусе **Черновик**, разработчик может перегенерировать Секретный ключ самостоятельно.
4. После передачи решения на модерацию Секретный ключ доступен только для просмотра и копирования.
5. Чтобы перегенерировать secretKey для решения не в статусе **Черновик**, разработчику необходимо обратиться к
   сотрудникам МоегоСклада.

#### Исходящие запросы МойСклад → Разработчик

МойСклад подписывает свои запросы
к [REST-эндпоинтам разработчика](#rest-andpointy-na-storone-razrabotchika-reshenij), передавая JWT-токен в заголовке
HTTP-запроса следующим образом:

Authorization: `Bearer <token> `

Описание полей JWT-payload:

| Поле  | Описание                                                                                                                                                              | Предполагаемое использование разработчиком                                                                  |
|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|
| "iat" | Время генерации токена в секундах от 1970-01-01T00:00:00Z UTC                                                                                                         | На усмотрение разработчика                                                                                  |
| "exp" | Время жизни токена в секундах от 1970-01-01T00:00:00Z UTC — позволяет ограничить срок валидности токена. После указанного момента времени токен считается невалидным. | При получении JWT после времени, указанного в "exp", следует отклонять запрос с ошибкой аутентификации      |
| "jti" | Уникальный идентификатор токена — позволяет отслеживать **одноразовость** применения токена                                                                           | При получении JWT с "jti", который был уже получен ранее, следует отклонять запрос с ошибкой аутентификации |

```text
JWT-header всегда такой:
```

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

```text
JWT-payload включает в себя следующие поля:
```

```json
{
  "iat": 1516239022,
  "exp": 1516239322,
  "jti": "6S3BQLsaSRNdEnhPCoW9lplY2LozRUOq"
}
```

#### Входящие запросы Разработчик → МойСклад

Разработчик при выполнении [REST запросов к МоемуСкладу по Vendor API](#rest-andpointy-na-storone-moegosklada) должен
подписывать их **одноразовым** токеном JWT. Токен следует передавать в заголовке HTTP-запроса:

Authorization: `Bearer <token>`

Поле "alg" в JWT-заголовке всегда должно иметь значение HS256. Соответственно, JWT-сигнатура всегда должна
генерироваться по алгоритму HMAC SHA-256 с использованием секретного ключа secretKey.

Описание полей JWT-payload:

| Поле  | Обязательное | Описание                                                                                                  | Обработка на стороне МоегоСклада                                                                |
|-------|--------------|-----------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------|
| "sub" | да           | appUid решения                                                                                         | Используется для идентификации и авторизации решения                                         |
| "iat" | да           | Время генерации токена в секундах от 1970-01-01T00:00:00Z UTC                                             | Используется для ограничения допустимого времени жизни токена                                   | 
| "exp" | нет          | Время жизни токена в секундах от 1970-01-01T00:00:00Z UTC. После этого момента токен считается невалидным | Если данное поле присутствует, оно также используется для проверки валидности токена по времени |
| "jti" | да           | Уникальный идентификатор токена                                                                           | Используется для проверки **одноразовости** использования токена                                |

В системе МоегоСклада есть следующие ограничения:

1. JWT-токен не может быть использован повторно. Для этого система проверяет значение поля "jti" на уникальность среди
   предыдущих запросов.
2. на максимальное время жизни для JWT-токена (порядка нескольких минут) — maxTokenLifetime. При проверке/валидации на
   стороне МоегоСклада значение "exp" ограничивается максимальным временем жизни. Если _(exp - iat)_ превышает
   maxTokenLifetime или поле "exp" отсутствует, в качестве "exp" используется _iat + maxTokenLifetime_. То есть:
   `effectiveExp = exp ? min(exp, iat + maxTokenLifetime) : iat + maxTokenLifetime`

```text
JWT-header может быть с указанием поля "typ":
```

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

```text
и без указания поля "typ":
```

```json
{
  "alg": "HS256"
}
```

```text
JWT-payload должен содержать следующие поля:
(поле "exp" — опциональное, остальные — обязательные)
```

```json
{
  "sub": "dummyapp.example-vendor",
  "iat": 1516239022,
  "exp": 1516239322,
  "jti": "6S3BQLsaSRNdEnhPCoW9lplY2LozRUOq"
}
```

#### Ошибки аутентификации и авторизации

Обработка ошибок аутентификации и авторизации на стороне МоегоСклада осуществляется аналогично тому, как это сделано
в [JSON API 1.2](https://dev.moysklad.ru/doc/api/remap/1.2/). То есть при возникновении ошибок возвращается аналогичный
объект `error` и заголовки HTTP-ответа **X-Lognex-Auth** и **X-Lognex-Auth-Message**.

