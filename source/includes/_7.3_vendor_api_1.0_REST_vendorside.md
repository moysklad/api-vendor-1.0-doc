### REST-эндпоинты на стороне вендора приложений

Если вендору требуется

+ активировать/деактивировать приложение у себя в системе при установке (возобновлении) и удалении (приостановке)
приложения на аккаунте пользователя МоегоСклада
+ получать токен для доступа к JSON API 1.2 

то в этом случае вендору со своей стороны требуется реализовать REST-endpoint с доступом по HTTPS
 и поддерживающий HTTP-методы **PUT**, **GET**, **DELETE**:

`https://<VENDOR-SERVER-ENDPOINT>/api/moysklad/vendor/1.0/apps/{appId}/{accountId}` 

где *VENDOR-SERVER-ENDPOINT* - тот URL, который указан в [дескрипторе приложения](#deskriptor-prilozheniq).

Здесь

+ **appId** `UUID` - идентификатор приложения в магазине приложений 
+ **accountId** `UUID` - идентификатор аккаунта в МоемСкладе


#### Активация приложения на аккаунте

Запрос должен обрабатываться сервером идемпотентно. Магазин приложений может повторять/дублировать запросы в 
соответствии со своей внутренней логикой (например, при работе механизма [Retry](#mehanizm-retry)).

<u>HTTP-метод</u>: **PUT**

<u>Content-Type</u>: **application/json**

В <u>теле запроса</u> передаем:

+ **appUid** `UUID` устанавливаемого приложения (может быть полезно видеть не только UUID приложения, но и его *appUid* - например, 
для разбора непонятных ситуаций и/или логирования)
+ **accountName** `String` - имя аккаунта, на который осуществляется подключение приложения (тоже полезно видеть не
 только UUID аккаунта, но и *accountName*)
+ **cause** `String` - основание (причина) активации, возможные значения:
    + **Install** - установка приложения на аккаунт
    + **Resume** (возможно только у **платных приложений**) - возобновление работы приложения на аккаунте после приостановки
+ **access** `Array`- доступы ресурсам, указанным в [дескрипторе приложения](#blok-access). Если ваше приложение
не требует доступа к API, то данный объект не придёт.
    + **resource** `String` - ресурс, к которому предоставлен доступ. Сейчас из ресурсов для приложений доступно 
    только JSON API 1.2 (`https://online.moysklad.ru/api/remap/1.2`)
    + **scope** `Array` - какие права предоставлены на доступ данному ресурсу. 
    На данный момент доступ предоставляется в двух вариантах - с правами администратора (`"scope": ["admin"]`) 
    и явно указанным набором прав (`"scope": ["custom"]`).
    + **permissions** - к каким объектам приложение может получить доступ. Включается в тело только для `"scope": ["custom"]`.
    Соответствует ответу в запросе на [получение списка прав Сотрудника](https://dev.moysklad.ru/doc/api/remap/1.2/dictionaries/#sushhnosti-sotrudnik-poluchit-informaciju-o-pravah-sotrudnika)
    + **access_token** `String` - Bearer токен доступа к данному ресурсу. 

В <u>теле ответа</u> ожидаем получить следующую JSON-структуру (обратите внимание, в ответе обязательно требуется 
HTTP-заголовок `Content-Type: application/json`, см. примеры ниже в правом столбце):

+ **status** `String` - статус активации приложения. Возможные значения: **Activating**, **SettingsRequired**, **Activated**.

| Статус               | Описание                                                             | Дальнейшие действия вендора                                                                                                             | Отображаемый пользователю статус приложения на витрине приложений |
|----------------------|----------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
| **Activating**       | приложение в процессе активации                                      | вендор оповестит магазин приложений по эндпоинту обратного вызова об изменении статуса приложения (на SettingsRequired или Activated)          | приложение подключается                                           |
| **SettingsRequired** | требуется настройка приложения пользователем                         | вендор оповестит магазин приложений об изменении статуса (на Activated), когда пользователь выполнит настройку приложения (через iframe-часть) | приложение требует настройки                                      |
| **Activated**        | приложение на аккаунте полностью активировано (и начало свою работу) | действий вендора не требуется                                                                                                           | приложение подключено                                             |

<u>HTTP status codes</u>:

+ **200 OK** - внешняя система (вендора) успешно обработала запрос на активацию приложения и вернула статус активации 
приложения на аккаунте в теле ответа
+ **551 Lifecycle Processing Failed** (кастомный статус) - внешняя система не смогла выполнить активацию приложения 
для аккаунта. Это ошибка активации приложения, установка приложения на аккаунте завершается с ошибкой, приложение НЕ 
становится установленным на аккаунт (переходит в специальное состояние **ActivationFailed**).
+ **прочие статусы** обрабатываются как ошибка - запускается механизм [Retry](#mehanizm-retry)

> Пример активации приложения при установке на аккаунт:

> **Request:** 

> **PUT**
> https://example.com/baseurl/api/moysklad/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f

> Body

```json
{
  "appUid": "example-app.example-vendor",
  "accountName": "dummyaccount",
  "cause": "Install",
  "access": [
    {
      "resource": "https://online.moysklad.ru/api/remap/1.2",
      "scope": ["admin"],
      "access_token": "6ab89be1ae6ff147755625ee8da948e42612233b"
    }
  ]
}
```
> ---

> **Response:**

> Response 200

> Content-Type: **application/json**

> Body: 

```json
{
  "status": "SettingsRequired"
}
``` 
> ---
> ---
> Пример активации **платного** приложения при возобновлении работы приложения на аккаунте (после поступления оплаты приложения):

> **Request:** 

> **PUT**
> https://example.com/baseurl/api/moysklad/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f

> Body

```json
{
  "appUid": "example-app.example-vendor",
  "accountName": "dummyaccount",
  "cause": "Resume",
  "access": [
    {
      "resource": "https://online.moysklad.ru/api/remap/1.2",
      "scope": ["admin"],
      "access_token": "6ab89be1ae6ff147755625ee8da948e42612233b"
    }
  ]
}
```
> ---

> **Response:**

> Response 200

> Content-Type: **application/json**

> Body: 

```json
{
  "status": "Activated"
}
``` 

> ---
> ---
> Пример активации приложения с блоком permissions (гибким набором прав):

> **Request:**

> **PUT**
> https://example.com/baseurl/api/moysklad/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f

> Body

```json
{
  "appUid": "app.test",
  "accountName": "account-test",
  "access": [
    {
      "resource": "https://online.moysklad.ru/api/remap/1.2",
      "scope": ["custom"],
      "permissions": {
        "supply": {
          "view": "ALL",
          "update": "ALL"
        },
        "viewDashboard": true,
        "viewAudit": true
      },
      "access_token": "test-token"
    }
  ],
  "cause": "Install"
}
```

> ---

> **Response:**

> Response 200

> Content-Type: **application/json**

> Body:

```json
{
  "status": "SettingsRequired"
}
``` 

#### Деактивация приложения на аккаунте


<u>HTTP-метод</u>: **DELETE**

<u>Тело запроса</u>: 

+ **cause** `String` - основание (причина) деактивации, возможные значения:
    + **Uninstall** - удаление приложения на аккаунте
    + **Suspend** (возможно только у **платных приложений**) - приостановка работы приложения на аккаунте 

<u>Тело ответа</u>: **пустое**

<u>HTTP status codes</u>:

+ **200 OK** - приложение успешно отключено (деактивировано) во внешней системе вендора
+ **404 Not Found** - приложение отключено/или никогда не было подключено (никогда не активировалось для данного аккаунта)
+ **551 Lifecycle Processing Failed** (кастомный статус) - внешняя система не смогла выполнить деактивацию приложения для аккаунта
+ прочие статусы обрабатываются как ошибка - запускается механизм [Retry](#mehanizm-retry)

> Пример деактивации приложения при удалении с аккаунта:
>
> **Request:** 

> **DELETE**
> https://example.com/baseurl/api/moysklad/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f

> Body

```json
{
  "cause": "Uninstall"
}
```

> ---

> **Response:**

> Response 200

> Content-Type: **application/json**

> ---
> ---

> Пример деактивации **платного** приложения при приостановке приложения на аккаунте (при отсутствии оплаты приложения):

> **Request:** 

> **DELETE**
> https://example.com/baseurl/api/moysklad/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f

> Body

```json
{
  "cause": "Suspend"
}
```

> ---

> **Response:**

> Response 200

> Content-Type: **application/json**

#### Проверка статуса активации приложения в системе вендора

<u>HTTP-метод</u>: **GET**

<u>Content-Type</u>: **application/json**

<u>Тело запроса</u>: **пустое**

<u>Тело ответа</u>:

+ **status** `String` - статус активации приложения. Возможные значения: **Activating**, **SettingsRequired**, **Activated**.

<u>HTTP status codes</u>:

+ **200 OK** - приложение активировано или активируется во внешней системе (статус активации - в теле ответа)
+ **404 Not Found** - приложение отключено/или никогда не было подключено для данного аккаунта

> Пример

> **Request:**

> **GET**
> https://example.com/api/moysklad/vendor/1.0/apps/5f3c5489-6a17-48b7-9fe5-b2000eb807fe/f088b0a7-9490-4a57-b804-393163e7680f

> ---
  
> **Response:** 

> Response 200

> Content-Type: **application/json**

> Response body

```json
{
  "status": "SettingsRequired"
}
```
