## Виджеты

Виджет - это плагин с визуальной частью, представляющей собой прямоугольный блок в конкретном месте в UI МоегоСклада. 
Содержимое блока определяется приложением.

### FAQ по виджетам

**Куда сейчас можно встраивать виджеты?**

На данный момент для встраивания виджетов доступны страницы:

- Контрагент - старая и новая карточки (entity.counterparty.view)
- Заказ покупателя (document.customerorder.edit)
- Отгрузка (document.demand.edit)

Во всех точках расширения виджеты имеют одинаковый функционал.

Если у пользователя установлены сразу несколько приложений с виджетами, встроенными на одну
страницу МС, то отобразятся все виджеты в порядке, соответствующем расположению родительских 
приложений на витрине. В новом редакторе контрагентов пользователь может сам поменять порядок 
отображения виджетов.

Список доступных для модернизации страниц (точек расширения) будет активно дополняться. 

**Хочу встроить виджет в точку МоегоСклада, которой нет в списке - что делать?**

Если вы хотите встроить виджет в какую-то точку МоегоСклада, но её пока нет в списке доступных точек расширения -
 обращайтесь с предложением 
в Telegram или по электронной почте, мы всегда открыты для таких запросов.


**Какими могут быть виджеты:**

Сейчас можно создать только виджеты с  

- фиксированной шириной: 416px - для всего виджета (с рамкой), 384px - для рабочей области (iframe, определяемый
приложением).
- фиксированной высотой: задается в дескрипторе.

Планируется реализация поддержки двух режимов отображения виджетов:

- развернутая форма (полная) - **реализована для всех точек расширения**
- свернутая форма (краткая) - пока реализована только в новом редакторе контрагентов.


### Жизненный цикл виджета

Виджет начинает отображаться на странице только после перехода приложения в статус **Activated**.
Если приложение предполагает настройку и статус **SettingsRequired** - виджет отобразится 
после настройки приложения.

При первом открытии страницы с виджетом (в рамках одной вкладки браузера) cистема МоегоСклада 
загружает виджет по HTTP GET-запросом по URL'у, указанному в теге sourceUrl. При этом система 
генерирует и передает GET-параметром одноразовый contextKey, по которому виджет получает текущий 
контекст пользователя  через [Vendor API](#blok-vendorapi).

Прочие данные передаются при помощи [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) в первом и последующих открытиях виджета.

В частности, при каждом открытии виджета система МоегоСклада отображает ранее загруженный iframe 
виджета (без повторной загрузки с сервера вендора) и через [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) передает 
в iframe этого виджета сообщение `Open`.

Без дополнительных настроек виджет отображает содержимое сразу, как только получает 
сообщение `Open`, даже если еще не успел обновить отображаемую информацию. 

В случае, если виджет использует протокол **open-feedback**, система не отображает 
 содержимое виджета сразу, а ждет ответного сообщения от виджета о готовности. 
 До этого момента внутри виджета отображается заглушка. Когда виджет готов, он 
 отправляет сообщение  `OpenFeedback`, после чего система полностью открывает 
 виджет пользователю.
 
Использование виджетом протокола **open-feedback** необходимо указать в [дескрипторе](#deskriptor-prilozheniq) 
приложения.

### Как работают виджеты

#### Описание конфигурации виджетов приложения в дескрипторе

Виджеты доступны для серверных приложений с дескриптором версии v2. 

Пример дескриптора приложения с виджетом в карточке контрагента расположен в правой части экрана.

> Дескриптор приложения с виджетом в карточке контрагента


```xml
   <ServerApplication xmlns="https://online.moysklad.ru/xml/ns/appstore/app/v2"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="https://online.moysklad.ru/xml/ns/appstore/app/v2
         https://online.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
       <iframe>...</iframe>
       <vendorApi>...</vendorApi>
       <access>...</access>
       <widgets>
           <entity.counterparty.view>
               <sourceUrl>https://b2b.moysklad.ru/widget/counter-party</sourceUrl>
               <height>
                   <fixed>28px</fixed>
               </height>
               <supports>
                   <open-feedback/>
               </supports>
           </entity.counterparty.view>
       </widgets>
   </ServerApplication>
```

Подробнее со структурой дескриптора для приложения с виджетом можно ознакомиться в
разделе [Дескриптор приложений](#deskriptor-prilozheniq).

В результате после установки и настройки приложения пользователем виджет отображается 
на карточке контрагента:

![useful image](widget-counterparty-page.png)

#### Загрузка виджета на странице

Виджет на странице загружается в iframe по URL, указанному в теге 
`<sourceUrl>...</sourceUrl>` виджета в [дескрипторе приложения](#deskriptor-prilozheniq).

Ширина содержимого виджета одинакова для виджетов всех приложений и равна 384px, 
а высота содержимого виджета статически указывается разработчиком в дескрипторе 
приложения (в данном примере 28px).

![useful image](widget-size.png)

Так же, как и для основного iframe-приложения, виджету GET-параметром передается 
`contextKey`, по которому через [Vendor API](#blok-vendorapi) можно получить информацию о текущем 
пользователе.

Пока происходит загрузка виджета - отображается ненавязчивый лоадер.
#### Кэширование виджетов

Система виджетов в МоемСкладе реализована таким образом, чтобы, по-возможности, 
загрузить виджет только один раз при первом открытии страницы с виджетом 
(в рамках одной вкладки браузера) и далее кэшировать iframe c загруженном в него
виджетом, переиспользуя его во всех последующих (в рамках одной вкладки
браузера) открытиях страницы с виджетом.

Несмотря на стремление к идеальному кэшированию - оно не гарантировано. 
То есть хост-окно может:

- физически создать несколько экземпляров iframe’ов для одной и той же 
точки расширения в рамках одной вкладки браузера (по тем или иным техническим 
причинам), причем эти экземпляры могут существовать одновременно
- не кэшировать iframe-виджета после загрузки

#### Открытие виджета

При открытии пользователем страницы с виджетом хост-окно отображает iframe
 виджета (только что загруженный или ранее закэшированный) и передает в
этот iframe виджета сообщение `Open` через [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage).

Пример сообщения `Open` cм. в правой части экрана.
> Сообщение Open

```json
    {
      "name": "Open",
      "messageId": 12345,
      "extensionPoint": "entity.counterparty.view",
      "objectId": "8e9512f3-111b-11ea-0a80-02a2000a3c9c",
      "displayMode": "expanded"
    }
```


Здесь `objectId` - это в данном случае идентификатор контрагента, так как 
точка расширения `entity.counterparty.view`. 

Виджет при получении сообщения `Open` может, например, обратиться на сервер 
за данными для указанного объекта `objectId` и отобразить их пользователю.

#### Протокол обратной связи при открытии виджета

По умолчанию при открытии закэшированного виджета его содержимое отображается сразу.

Если виджет при открытии делает обращение к серверу, то может быть видна 
небольшая задержка и в это время будет отображается прежнее состояние/содержание 
виджета (например, данные для прошлого контрагента).

Протокол обратной связи позволяет виджету явно сообщить хост-окну в какой именно 
момент отобразить содержимое виджета. До этого содержимое виджета будет закрыто 
ненавязчивым лоадером:

![useful image](loader-in-widget.png)

> Тег дополнительных протоколов supports с протоколом open-feedback


```xml
    <supports>
        <open-feedback/>
    </supports>
```

Для переключения хост-окна на использование протокола обратной связи при открытии виджета 
в дескрипторе для виджета надо явно указать поддержку дополнительного протокола **open-feedback**. Пример
тега дополнительных протоколов supports с указанным в нем протоколом **open-feedback** см. в правой части экрана.



Виджет передает сообщение `OpenFeedback` хост-окну в качестве сигнала готовности содержимого 
виджета для отображения пользователю. Пример сообщения  `OpenFeedback` - в правой части экрана.

> Cообщение OpenFeedback

```json 
{
  "name": "OpenFeedback",
  "correlationId": 12345
}
```

Здесь `correlationId` содержит значение `messageId` ранее полученного сообщения `Open`.

Хост-окно, получив сообщение `OpenFeedback`, отображает содержимое виджета пользователю 
(убирает ненавязчивый лоадер).
