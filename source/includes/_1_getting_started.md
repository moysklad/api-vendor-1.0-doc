# Документация разработчика решений для Каталога решений МойСклад

## Быстрый старт

SaaS-сервис управления торговлей [МойСклад](https://online.moysklad.ru/) дает возможность сторонним разработчикам размещать решения в каталоге решений МоегоСклада, а пользователям МоегоСклада — устанавливать и пользоваться этими решениями. 

Решение — программный продукт, который расширяет и дополняет функциональность МоегоСклада. Решения размещаются в каталоге решений. 

Каталог решений — это отдельный экран МоегоСклада, на котором размещаются опубликованные решения. Каталог [доступен](https://online.moysklad.ru/app/#apps?page=all_apps) всем пользователям МоегоСклада, размещение решений — только разработчику, установка решений — только администратору.

Разработчик управляет своими решениями через аккаунт разработчика. Аккаунт разработчика — привязанный к конкретному разработчику аккаунт МоегоСклада. На таком аккаунте в каталоге решений отображаются решения разработчика в статусах **Черновик (Draft)** и **Готово, отправлено на модерацию (Ready)**. Это позволяет выполнять проверку и отладку решений до их публикации для всех пользователей МоегоСклада. К одному разработчику может быть привязано несколько аккаунтов.

Конечный пользователь сервиса МойСклад также работает с МоимСкладом в рамках своего аккаунта. Обычно аккаунт соответствует одной компании или бизнесу. В аккаунте может быть несколько пользователей. Один из этих пользователей имеет права администратора аккаунта. 

Партнер МоегоСклада — это компания, получающая бесплатный доступ к решениям с целью рекламы, распространения и их продажи новым и существующим пользователям МоегоСклада. Установки решений на аккаунт партнера имеют признак `notForResale` в атрибутах подписки, а установки решений пользователям через партнера имеют признак `partner` (см. например [Получение статуса решения на аккаунте](#poluchenie-statusa-resheniq-na-akkaunte)).

## Как создать и опубликовать решение 

Для каталога решений МоегоСклада можно создать решение на любом языке программирования с использованием любых фреймворков. Допустимые типы решений: [серверные решения](#serwernye-resheniq), [телефония](#telefoniq). 

Решения интегрируются с МоимСкладом с помощью различных API: серверные решения могут использовать [JSON API 1.2](https://dev.moysklad.ru/doc/api/remap/1.2), [Loyalty API](https://dev.moysklad.ru/doc/api/loyalty/1.0) и [FiscalAPI](https://dev.moysklad.ru/doc/api/fiscal/1.0), 
решения телефонии — [Phone API 1.0](https://dev.moysklad.ru/doc/api/phone/1.0). 

Процесс создания решений телефонии описан в [Сценарии работы с Phone API 1.0](https://dev.moysklad.ru/doc/api/phone/1.0/#%D1%81%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B9-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B). 

Пошаговый процесс создания серверных решений рассмотрим ниже.

1. Создайте бизнес-логику решения на сервере.

2. Создайте черновик решения в [личном кабинете разработчика](#lichnyj-kabinet-razrabotchika), используя один из примеров [дескриптора](#deskriptor-resheniq). После создания черновика вы получите appId, appUid, secret key, необходимые для работы с Vendor API.

3. Реализуйте эндпоинты согласно спецификации [Vendor API 1.0](#vendor-api-1-0), чтобы обрабатывать [события](#rest-andpointy-na-storone-razrabotchika-reshenij) решения. При установке и возобновлении решения МойСклад передает [токен для доступа](#dostup-po-tokenu-k-json-api) к [JSON API 1.2](https://dev.moysklad.ru/doc/api/remap/1.2).

4. Если пользователь должен будет настраивать решение при его установке на аккаунт, то в ответе на [запрос установки решения](#aktiwaciq-resheniq-na-akkaunte) верните **SettingsRequired** и реализуйте [iframe-часть решения](#glawnyj-iframe). По возможности используйте [UI Kit МоегоСклада](https://github.com/moysklad/html-marketplace-1.0-uikit). При необходимости предусмотрите ролевую модель для ограничения доступа к функциональности решения.

5. Если в решении нужны дополнительные поля для сущностей и/или документов, создайте их через JSON API 1.2 в рамках [активации решения](#process-aktiwacii-resheniq-na-akkaunte). Если при этом процесс создания занимает более одной минуты, используйте асинхронную активацию с возвратом статуса **Activating**.

6. Если решение нужно встроить в интерфейс МоегоСклада, то можно:
  * добавить [виджет](#vidzhety) решения. Для этого нужно реализовать iframe-часть виджета и обновить [дескриптор](#deskriptor-resheniq), добавив тег `widgets`. 
  * добавить [кастомную кнопку](#kastomnye-knopki). Для этого нужно реализовать [эндпоинт обработчика нажатия на кнопку в vendorApi](#obrabotka-nazhatiq-na-kastomnuu-knopku) и обновить [дескриптор](#deskriptor-resheniq), добавив тег `buttons`.

7. Если решение поддерживает работу с системой лояльности, реализуйте на своей стороне поддержку Loyalty API и после установки решения сохраните настройки программы лояльности через [запрос изменения настроек лояльности на аккаунте](#izmenenie-nastroek-loql-nosti-na-akkaunte). Подробнее про процесс взаимодействия с системами лояльности см. [Сценарии работы с LoyaltyAPI](https://dev.moysklad.ru/doc/api/loyalty/1.0/#scenarij-raboty).

8. Если решение поддерживает работу с операциями фискализации, реализуйте на своей стороне поддержку [Fiscal API](https://dev.moysklad.ru/doc/api/fiscal/1.0).

9. Если решение поддерживает работу с оплатой по QR-коду, реализуйте на своей стороне поддержку QrPay API.

9. [Разместите](#uslowiq-razmescheniq-reshenij) решение в каталоге решений.

## Порядок размещения решения в каталоге решений

После готовности решения на стороне разработчика в общем случае разработчику нужно выполнить следующие шаги по размещению 
решения в каталоге решений:

1. Создать Черновик решения в личном кабинете разработчика.
2. После создания Черновика на странице редактирования решения будет доступен [Секретный ключ](#sekretnyj-kluch-secretkey) (Secret Key).
3. Создать [аккаунт разработчика](#otladka-reshenij-na-akkauntah-razrabotchika), привязав [аккаунт МоегоСклада](https://online.moysklad.ru/) к аккаунту в [личном кабинете разработчика](#lichnyj-kabinet-razrabotchika).
4. Протестировать и отладить решение на аккаунте разработчика.
5. Отправить решение на модерацию через личный кабинет разработчика.

Далее сотрудник МоегоСклада проверяет решение. Если решение проходит проверку, оно публикуется в каталоге решений в течение 2 рабочих дней. Если решение не проходит проверку, оно возвращается разработчику для устранения замечаний. 

## Демо-решение

Для демонстрации взаимодействия решений с каталогом решений МоегоСклада было создано демо-решение на PHP.

В демо-решении реализованы следующие функции:

* Активация с получением токена доступа к JSON API 1.2 и деактивация по Vendor API.
* Использование основной iframe-части для настройки решения администратором аккаунта с обновлением статуса в каталоге решений.
* Получение контекста пользователя для iframe — отображение информации по пользователю, проверка прав администратора.
* Получение информации из МоегоСклада по JSON API 1.2 с доступом по токену.

Более подробная информация и исходный код решения доступны по [ссылке](https://github.com/moysklad/php-dummyapp-marketplace-1.0).
