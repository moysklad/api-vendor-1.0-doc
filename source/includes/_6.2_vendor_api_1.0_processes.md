### Процесс активации решения на аккаунте

Активация решения — это процесс включения решения для конкретного аккаунта в системе разработчика. 
Выполняется при подключении решения пользователем или при возобновлении платного решения. 
В рамках активации происходит [оповещение сервера разработчика со стороны МоегоСклада](#aktiwaciq-resheniq-na-akkaunte).

В общем виде процесс активации решения выглядит так:

1. Пользователь МоегоСклада устанавливает решение. 
2. МойСклад делает HTTP PUT запрос на сервер разработчика, в том числе передавая причину активации и токен доступа к JSON API, если в дескрипторе решения такой доступ запрашивается. При этом доступ по переданному токену уже работает.
3. Сервер разработчика в рамках допустимого тайм-аута отвечает на запрос одним из статусов в теле ответа:
    + **Activating** — статус предназначен для асинхронной активации на стороне разработчика — если в рамках 
    допустимого тайм-аута обработки HTTP PUT запроса не получается активировать решение. Например, для активации 
    решения требуется несколько минут. Далее разработчик должен оповестить МойСклад через эндпоинт **Изменение статуса решения на аккаунте** о завершении активации решения статусом **Activated** или о том, что 
    решению требуется настройка статусом **SettingsRequired**.
    + **SettingsRequired** — статусом, с помощью которого разработчик сообщает МоемуСкладу, что решению требуется настройка пользователем через iframe-часть решения. После того как пользователь настроит решение, разработчик должен оповестить МойСклад через [эндпоинт изменения статуса решения на аккаунте](#izmenenie-statusa-resheniq-na-akkaunte) об активации решения, передав статус **Activated**.
    + **Activated** — статус означает, что решение сразу было полностью активировано и уже работает.
4. Если сервер разработчика возвращает ответ со HTTP-статусом `4хх` или `551`, то МойСклад переводит решение в статус ошибки установки (**ActivationFailed**). Токен доступа к JSON API при этом удаляется. 
5. Если сервер разработчика не отвечает или возвращает ответ с прочим статусом `5хх`, то МойСклад делает повтор запроса через механизм [Retry](#mehanizm-retry).

### Процесс деактивации решения на аккаунте

Деактивация решения — это процесс выключения решения для конкретного аккаунта в системе разработчика. Выполняется при отключении решения пользователем или при приостановке платного решения. При деактивации происходит [оповещение сервера разработчика со стороны МоегоСклада](#deaktiwaciq-resheniq-na-akkaunte).

Процесс деактивации решения выглядит так:

1. Пользователь МоегоСклада нажимает на кнопку **Удалить** в карточке решения.
    + **Для платных решений возможна приостановка в случаях:** 
        + У пользователя, на аккаунте которого есть установленные платные решения, кончается подписка.
        + Пользователь, на аккаунте которого есть установленные платные решения, оплачивает подписку меньшей суммой, чем требуется для оплаты установленных платных решений.        
2. МойСклад аннулирует доступ по токену, если он был выдан, и выполняет HTTP DELETE запрос с причиной деактивации к серверу разработчика. На момент получения разработчиком оповещения по деактивации доступ по токену уже не работает.
3. Если сервер разработчика возвращает ответ со HTTP-статусом `4хх` или `551`, то МойСклад переводит решение в статус ошибки удаления (**DeactivationFailed**).
4. Если сервер разработчика не отвечает или возвращает ответ с прочим статусом `5хх`, то МойСклад делает повтор запроса через механизм [Retry](#mehanizm-retry).

### Процесс приостановки и возобновления работы решения на аккаунте

Приостановка решения — это автоматический процесс выключения платного решения при отсутствии на счету пользователя
МоегоСклада суммы, необходимой для оплаты подписки. После приостановки [токен доступа решения](#dostup-po-tokenu-k-json-api) аннулируется. 

Возобновление решения — это процесс включения приостановленного платного решения.
Возобновление может быть выполнено:

- автоматически после пополнения баланса, если в решении включено автопродление;
- при оплате подписки пользователем МоегоСклада.

После возобновления решению выдается новый [токен доступа](#dostup-po-tokenu-k-json-api). 

### Уведомления о дополнительных событиях

Есть возможность получать дополнительные события о действиях с приложением со стороны пользователя.

Поддержку таких событий необходимо явно объявлять в дескрипторе, см. [Блок дополнительных событий](#blok-dopolnitel-nyh-sobytij)

#### Событие изменения прав установки (updatePermissions)

Получение обновлённых прав установки от МоегоСклада, когда права для токена у пользователя изменены.

Права для токена обновляются в случаях:

* Модератор публикует следующую версию вашего приложения с новым набором прав, пользователь подтверждает изменение (основной сценарий)
* При принудительном обновлении токена силами МоегоСклада (используется только в экстренных случаях)

Чтобы получать событие, нужно выполнить 2 условия:

1. Объявить о поддержке события `updatePermissions` через дескриптор, см. [блок additionalEvents в дескрипторе](#blok-dopolnitel-nyh-sobytij)
2. Реализовать на сервере разработчика [эндпоинт для получения событий](#obrabotka-dopolnitel-nyh-sobytij)

### Механизм Retry

Механизм повтора попыток Retry позволяет выполнить запрос к системе разработчика в случае ее временной недоступности 
(в ответе от сервера возвращается один из `5хх` статусов или происходит таймаут при ожидании ответа).

Для того чтобы отличить повторную попытку от нового запроса, МойСклад добавляет в каждый запрос заголовок `X_Lognex_RequestId`.
При повторной попытке значение этого заголовка не меняется.

Процесс повтора попыток определяется двумя параметрами:

- максимальная длительность повторений,
- периодичность (время задержки до очередного повтора).

Значение параметров отличается для разных эндпоинтов и типов событий: 

| Эндпоинт/Событие                                                                                                          | Длительность | Периодичность  | 
|---------------------------------------------------------------------------------------------------------------------------|--------------|----------------|
| [Активация решения на аккаунте](#aktiwaciq-resheniq-na-akkaunte) <br/>(кроме событий `TariffChanged`, `Autoprolongation`) | 3 минуты     | 10 сек         |
| [Дективация решения на аккаунте](#deaktiwaciq-resheniq-na-akkaunte)                                                       | 3 минуты     | 10 сек         |
| [Обработка дополнительных событий](#obrabotka-dopolnitel-nyh-sobytij)                                                     | 24 часа      | 5 минут        |
| [Активация решения на аккаунте](#aktiwaciq-resheniq-na-akkaunte) <br/>(для событий `TariffChanged`, `Autoprolongation`)   | 24 часа      | 5 минут        |

Если достигнут лимит максимальной длительности повторений, попытки прекращаются. Дальнейшее поведение системы зависит от операции, которую пытались выполнить.

