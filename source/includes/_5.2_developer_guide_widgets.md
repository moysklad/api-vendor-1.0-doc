### Главный iframe

Главный iframe решения — это основное окно для настройки и работы с серверным решением, которое открывается при нажатии 
на кнопку **Начать работу** в каталоге либо при переходе по прямой ссылке вида 
`https://online.moysklad.ru/app/#embed-apps?id={appId}`.

За настройку и работу этого элемента отвечает [блок iframe в дескрипторе](#blok-iframe). 
В случае отсутствия этого блока считается, что у решения отсутствует iframe-часть. 

При реализации главного iframe решения следует учитывать следующее:

1. По возможности используйте [UI Kit МоегоСклада](https://github.com/moysklad/html-marketplace-1.0-uikit) для визуального оформления содержимого.
1. Если в iframe будет какая-либо пользовательская функциональность кроме настроек, предусмотрите доступ к этой функциональности для пользователей с разными правами доступа, не только для администратора.
1. Если содержимое iframe не умещается в минимальную допустимую высоту окна (768px), то необходимо добавить
   [js скрипт](https://apps-api.moysklad.ru/js/ns/appstore/app/v1/moysklad-iframe-expand-3.js)
   для автоматического масштабирования высоты окна в зависимости от контента на свою страницу. Пример:

```html
<!doctype html>
<html>

<head>
  ...
</head>

<body>
...
<script type="text/javascript"
        src="https://apps-api.moysklad.ru/js/ns/appstore/app/v1/moysklad-iframe-expand-3.js"></script>
</body>

</html>
```

### Виджеты

Виджет — это плагин, имеющий визуальную часть. Визуальная часть виджета — прямоугольный блок, который встраивается в интерфейс МоегоСклада в определенном месте. Содержимое блока определяется решением.

> Дескриптор решения с виджетом в карточке контрагента

```xml
   <ServerApplication xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2
         https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
       <iframe>...</iframe>
       <vendorApi>...</vendorApi>
       <access>...</access>
       <widgets>
           <entity.counterparty.edit>
               <sourceUrl>https://b2b.moysklad.ru/widget/counter-party</sourceUrl>
               <height>
                   <fixed>61px</fixed>
               </height>
               <supports>
                   <open-feedback/>
                   <save-handler/>
               </supports>
                <uses>
                    <good-folder-selector/>
                </uses>
           </entity.counterparty.edit>
       </widgets>
   </ServerApplication>
```

Виджеты можно добавить на страницы МоегоСклада, которые есть в [списке](#blok-widgets). Чтобы встроить виджет на страницу, которая пока не поддерживается, свяжитесь с нами в Telegram или по электронной почте.

Виджеты доступны для серверных решений с дескриптором версии v2. Пример дескриптора решения с виджетом в карточке контрагента расположен в правой части экрана.
Подробнее структура дескриптора для решения с виджетом описана в разделе [Дескриптор решений](#deskriptor-resheniq).

#### Загрузка и отображение виджета на странице

Виджет на странице загружается в iframe по URL, указанному в теге `<sourceUrl>...</sourceUrl>` виджета в дескрипторе.

Виджет начинает отображаться на странице только после перехода решения в статус **Activated**.
Если решение предполагает настройку и статус **SettingsRequired**, виджет отображается после настройки решения.

После того как пользователь установил и настроил решение с дескриптором из примера выше, виджет будет показан в карточке контрагента.

![useful image](widget-counterparty-page.png)

Виджеты отображаются в двух режимах:

- развернутая форма (полная) — виджет отображается с рабочей iframe-областью;
- свернутая форма — рабочая область виджета скрыта.

Если у пользователя установлены несколько решений с виджетами, встроенными на одну страницу МоегоСклада, отображаются все виджеты.
Порядок отображения соответствует расположению родительских решений в каталоге. В редакторах, поддерживающих функцию Drag-and-drop, пользователь может сам поменять порядок отображения виджетов.

Параметры содержимого виджетов:

- ширина 400px — для виджетов всех решений,
- высота — статически указывается разработчиком в дескрипторе решения. В примере высота — 61px.

![useful image](widget-size.png)

#### Кэширование виджетов

Система виджетов в МоемСкладе реализована так, чтобы, по-возможности, загружать виджет один раз. При первом открытии страницы с виджетом в рамках одной вкладки браузера происходит загрузка. Далее iframe c загруженным в него виджетом кэшируется и переиспользуется во всех последующих открытиях страницы с виджетом в рамках одной вкладки браузера.

Если по техническим причинам кэширование не произошло, хост-окно может:

- создать несколько iframe-экземпляров для одной точки расширения в рамках одной вкладки браузера (эти экземпляры могут существовать одновременно);
- не кэшировать iframe виджета после загрузки.


#### Как работают виджеты

При первом открытии страницы с виджетом в рамках одной вкладки браузера cистема МоегоСклада загружает виджет по HTTP GET-запросом по URL, указанному в теге sourceUrl. При этом система генерирует и передает GET-параметром `contextKey` ключ, по которому виджет получает текущий 
контекст пользователя через [Vendor API](#poluchenie-kontexta-pol-zowatelq-dlq-reshenij-s-iframe-chast-u-kastomnymi-modal-nymi-oknami-i-widzhetami).

Прочие данные передаются c помощью [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) при первом и последующих открытиях виджета. Так, при каждом открытии виджета система МоегоСклада отображает ранее загруженный iframe виджета без повторной загрузки с сервера разработчика, и через [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) передает в iframe этого виджета сообщение `Open`.

Без дополнительных настроек виджет отображает содержимое сразу, как только получает сообщение `Open`. Даже если еще не успел обновить отображаемую информацию. 

Примеры JS-кода доступны в [демо-решении](https://github.com/moysklad/php-dummyapp-marketplace-1.0/blob/master/src/php/widgets/widget.html.php) на GitHub. Примеры демонстрируют:

- как получить сообщение `Open` с идентификатором документа `objectId`, в котором открыт виджет;
- как залогировать в консоль входящие и исходящие сообщения, то есть сообщения от виджета и к виджету.

Если виджет поддерживает [протокол **open-feedback**](#protokol-obratnoj-swqzi-pri-otkrytii-widzheta), система не отображает содержимое виджета сразу, а ждет ответного сообщения от виджета о готовности. До этого момента внутри виджета отображается заглушка. Когда виджет готов, он отправляет сообщение `OpenFeedback`. После этого система полностью открывает виджет пользователю.
 
Если виджет поддерживает [протокол **change-handler**](#poluchenie-sostoqniq-redaktiruemogo-ob-ekta), при редактировании документа пользователем на странице с виджетом он оповещается об изменениях, получая сообщение `Change`, содержащее несохраненное состояние документа. 
 
Если виджет поддерживает [протокол **update-provider**](#izmenenie-sostoqniq-redaktiruemogo-ob-ekta), при редактировании документа пользователем на странице с виджетом 
он может изменять несохраненное состояние документа, отправляя сообщение `UpdateRequest` со списком полей, которые необходимо изменить. 
 
При сохранении страницы с виджетом, если виджет, который находится на экране редактирования сущности, поддерживает [протокол **save-handler**](#sohranenie-pol-zowatelem-redaktiruemogo-ob-ekta), он оповещается о факте сохранения объекта пользователем, получая сообщение `Save`.

Виджет, поддерживающий [протокол **dirty-state**](#priznak-nesohranennogo-sostoqniq-widzheta), может сообщить хост-окну, что в виджете есть несохраненные изменения. Для этого виджет отправляет хост-окну сообщение `SetDirty`. Виджет может отправить хост-окну сообщение `ClearDirty`, после чего диалог подтвержения закрытия окна не будет появляться, при условии, что отсутствуют несохраненные изменения в самом UI МоегоСклада или в других виджетах. Внутренний dirty-флаг для виджета в хост-окне сбрасывается при открытии. То есть при отправке сообщения `Open` хост-окно считает, что в виджете нет несохраненных изменений.
 
Поддержку виджетом протоколов **open-feedback**, **save-handler**, **dirty-state**, **change-handler** необходимо указать в [дескрипторе](#deskriptor-resheniq)   решения.
Каждая точка встраивания имеет свой [список поддерживаемых протоколов](#dostupnost-dopolnitel-nyh-protokolow-w-zawisimosti-ot-tochek-wstraiwaniq).

Виджеты на страницах создания, например в точке встраивания `document.customerorder.create`, имеют ограниченную функциональность
по сравнению с виджетами на страницах редактирования, например `document.customerorder.edit`. Это выражается в меньшем количестве поддерживаемых протоколов и в реализации самих протоколов. Например, в сообщении **Change** часть полей, которые заполняются после первого сохранения документа (`id`, `created`, `meta` и другие) будет заполнено значением `null`.

Поддержка [сервисных протоколов](#blok-serwisnyh-protokolow-uses) виджетами на страницах создания пока не реализована.

#### Открытие виджета

Когда пользователь открывает страницу с виджетом, хост-окно отображает iframe виджета, только что загруженный или ранее закэшированный, и передает в этот iframe сообщение `Open` через [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage).

Пример сообщения `Open` cмотрите в правой части экрана.

> Сообщение Open для виджета на экране создания в Заказе покупателя

```json
    {
      "name": "Open",
      "messageId": 12345,
      "extensionPoint": "document.customerorder.create",
      "objectId": null,
      "displayMode": "expanded"
    }
```

> Сообщение Open для виджета на экране редактирования в Заказе покупателя

```json
    {
      "name": "Open",
      "messageId": 12345,
      "extensionPoint": "document.customerorder.edit",
      "objectId": "8e9512f3-111b-11ea-0a80-02a2000a3c9c",
      "displayMode": "expanded"
    }
```

Здесь: 

- `extensionPoint` — текущая точка расширения;
- `objectId` — идентификатор текущего документа или сущности. Для виджета, отображаемого на экране создания, значение — `null`;
- `displayMode` — режим отображения виджета. Сейчас может принимать только одно значение `expanded`.

Виджет при получении сообщения `Open` может, например, обратиться на сервер за данными для указанного объекта `objectId` и отобразить их пользователю.

**Примечание**: в сообщении Open передается идентификатор текущей открытой сущности в карточке, который отображается в URL браузера в параметре `id`. Несмотря на то, что для сущностей Товар, Услуга, Комплект и Модификация этот идентификатор отличается от используемого в remap API, запрос по нему по-прежнему будет работать. При этом сервер будет использовать [редирект](https://developer.mozilla.org/ru/docs/Web/HTTP/Status/308) . 
Пример запроса для Товара `https://online.moysklad.ru/app/#good/edit?id=9e73d736-a0de-11e9-9109-f8fc00095c7f` приведен в правой части экрана. Для упрощения часть вывода пропущена.

> Ответ на запрос получения Товара  

```shell
curl -X GET --location "https://api.moysklad.ru/api/remap/1.2/entity/product/9e73d736-a0de-11e9-9109-f8fc00095c7f"     -H "Content-Type: application/json"     -H "Authorization: Bearer ..." -v 

> GET /api/remap/1.2/entity/product/9e73d736-a0de-11e9-9109-f8fc00095c7f HTTP/1.1
> Host: online.moysklad.ru
> User-Agent: curl/7.68.0
> Accept: */*
> Content-Type: application/json
> Authorization: Bearer ...
> 
* Mark bundle as not supporting multiuse
< HTTP/1.1 308 Permanent Redirect
< Server: nginx/1.18.0
< Date: Fri, 28 Jan 2022 11:13:00 GMT
< Content-Length: 0
< Connection: keep-alive
< Cache-Control: max-age=0, no-cache
< X-Lognex-Reset: 0
< X-Lognex-Retry-After: 0
< Location: https://api.moysklad.ru/api/remap/1.2/entity/product/9e73e41d-a0de-11e9-9109-f8fc00095c81
< X-Lognex-Retry-TimeInterval: 3000
< X-RateLimit-Remaining: 44
< X-RateLimit-Limit: 45
< Strict-Transport-Security: max-age=15552000
< 
* Connection #1 to host online.moysklad.ru left intact
* Issue another request to this URL: 'https://api.moysklad.ru/api/remap/1.2/entity/product/9e73e41d-a0de-11e9-9109-f8fc00095c81'
* Found bundle for host online.moysklad.ru: 0x55cb04fa3970 [serially]
* Can not multiplex, even if we wanted to!
* Re-using existing connection! (#1) with host online.moysklad.ru
* Connected to online.moysklad.ru (88.212.252.4) port 443 (#1)
> GET /api/remap/1.2/entity/product/9e73e41d-a0de-11e9-9109-f8fc00095c81 HTTP/1.1
> Host: online.moysklad.ru
> User-Agent: curl/7.68.0
> Accept: */*
> Content-Type: application/json
> Authorization: Bearer ...
> 
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< Server: nginx/1.18.0
< Date: Fri, 28 Jan 2022 11:13:00 GMT
< Content-Type: application/json;charset=utf-8
< Content-Length: 6535
< Connection: keep-alive
< Vary: Accept-Encoding
< Cache-Control: no-cache
< X-Lognex-Reset: 0
< X-Lognex-Retry-After: 0
< X-Lognex-Retry-TimeInterval: 3000
< X-RateLimit-Remaining: 43
< X-RateLimit-Limit: 45
< Strict-Transport-Security: max-age=15552000
< 
{
  "meta" : {
    "href" : "https://api.moysklad.ru/api/remap/1.2/entity/product/9e73e41d-a0de-11e9-9109-f8fc00095c81",
    "metadataHref" : "https://api.moysklad.ru/api/remap/1.2/entity/product/metadata",
    "type" : "product",
    "mediaType" : "application/json",
    "uuidHref" : "https://online.moysklad.ru/app/#good/edit?id=9e73d736-a0de-11e9-9109-f8fc00095c7f"
  },
  "id" : "9e73e41d-a0de-11e9-9109-f8fc00095c81",
  ...
}
```

#### Протокол обратной связи при открытии виджета

По умолчанию при открытии закэшированного виджета его содержимое отображается сразу.

Если виджет при открытии делает обращение к серверу, может быть видна небольшая задержка. В это время будет отображается прежнее состояние и содержание виджета, например, данные для прошлого контрагента.

Протокол обратной связи позволяет виджету явно сообщить хост-окну в какой именно момент отобразить содержимое виджета. До этого содержимое виджета будет закрыто ненавязчивым лоадером:

![useful image](loader-in-widget.png)

> Тег дополнительных протоколов supports с протоколом open-feedback


```xml
    <supports>
        <open-feedback/>
    </supports>
```

Для переключения хост-окна на использование протокола обратной связи при открытии виджета в дескрипторе для виджета надо явно указать поддержку дополнительного протокола **open-feedback**. Пример
тега дополнительных протоколов supports с указанным в нем протоколом **open-feedback** смотрите в правой части экрана.

Виджет передает сообщение `OpenFeedback` хост-окну в качестве сигнала готовности содержимого виджета для отображения пользователю. Пример сообщения `OpenFeedback` смотрите в правой части экрана.

> Cообщение OpenFeedback

```json 
{
  "name": "OpenFeedback",
  "correlationId": 12345
}
```

Здесь `correlationId` содержит значение `messageId` ранее полученного сообщения `Open`.

Хост-окно, получив сообщение `OpenFeedback`, отображает содержимое виджета пользователю и убирает лоадер.

#### Сохранение пользователем редактируемого объекта

Хост-окно может оповещать виджет о факте сохранения редактируемого объекта. Для этого в дескрипторе для виджета нужно объявить поддержку опционального протокола **save-handler**.

  > Тег дополнительных протоколов supports с протоколом save-handler
  
  ```xml
      <supports>
          <save-handler/>
      </supports>
  ```
 
 Хост-окно отправляет виджету сообщение `Save` через [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) при сохранении редактируемого объекта после сохранения объекта в базе данных. То есть на момент получения виджетом сообщения Save сохраненное состояние объекта уже доступно через JSON API.
 
 Сохранение редактируемого объекта инициируется пользователем:
 
 - при явном нажатии на кнопку **Сохранить**, в том числе при сохранении объекта без фактического внесения изменений;
 
 - при покидании объекта и его явном сохранении через диалог подтверждения сохранения изменений, в том числе при листании кнопками-стрелочками на соседние объекты;
 
 - при автоматическом сохранении изменений закрываемого объекта, например, при создании связанного документа Отгрузки из Заказа покупателя.
 
 Пример сообщения `Save` cмотрите в правой части экрана.
 
 > Сообщение Save
 
 ```json
     {
       "name": "Save",
       "messageId": 32109,
       "extensionPoint": "entity.counterparty.edit",
       "objectId": "8e9512f3-111b-11ea-0a80-02a2000a3c9c"
     }
 ```

Здесь:

- `extensionPoint` — текущая точка расширения;
- `objectId` — идентификатор текущего документа или сущности, аналогичен идентификатору в сообщении `Open`.

#### Признак несохраненного состояния виджета

> Тег дополнительных протоколов supports с протоколом dirty-state
  
```xml
  <supports>
      <dirty-state/>
  </supports>
```
Хост-окно поддерживает подтверждение закрытия окна пользователем, если он изменил данные в форме виджета, но не сохранил их. Для этого в дескрипторе для виджета нужно объявить поддержку опционального протокола **dirty-state**.

 
> Сообщение SetDirty

```json
    {
      "name": "SetDirty",
      "messageId": 12,
      "openMessageId": 7
    }
```
После того, как пользователь внес изменения в виджет, он отправляет хост-окну сообщение `SetDirty`. Пример сообщения SetDirty смотрите в правой части экрана. 

Здесь openMessageId содержит значение messageId ранее полученного сообщения `Open`.

Система учитывает, что в виджете есть несохраненные изменения. Далее, если пользователь нажимает кнопку **Закрыть** или другим способом пытается уйти с формы редактирования, система отображает диалог подтверждения сохранения изменений:

 ![useful image](confirm-save-popup.png)

> Сообщение ClearDirty

```json
    {
      "name": "ClearDirty",
      "messageId": 13
    }
```
Если виджет после отправки `SetDirty` отправляет хост-окну сообщение `ClearDirty`, система не учитывает данный виджет при отображении диалога подтверждения сохранения изменений. То есть, если отсутствуют прочие несохраненные изменения самого объекта или в других виджетах, система не запрашивает диалог подтверждения сохранения изменений при закрытии редактируемого объекта.

#### Получение состояния редактируемого объекта

Хост-окно может оповещать виджет об изменениях несохраненного состояния редактируемого объекта. Для этого в дескрипторе для виджета нужно объявить поддержку опционального протокола **change-handler**.

  > Тег дополнительных протоколов supports с протоколом change-handler
  
  ```xml
      <supports>
          <change-handler/>
      </supports>
  ```
 
 Хост-окно отправляет виджету сообщение `Change` через [postMessage](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage), содержащее несохраненное состояние документа при редактировании документа пользователем.
 
 Отправка сообщения `Change` инициируется при следующих действиях пользователя:
 
 - при изменении полей документа, в том числе дополнительных полей, путем редактирования/выбора значения в селекторе;
 - при добавлении/удалении/редактировании позиций документа.
 
 Отправка сообщения `Change` **не происходит** в следующих случаях:
 
 - при открытии экрана редактирования документа;
 - при изменении состояния документа в результате сохранения пользователем;
 - при изменении полей, которые не поддерживаются;
 - если при редактировании значение редактируемого поля не изменилось, то есть при отсутствии реальных изменений.
 
 
 Узнать, для каких точек поддерживается протокол **change-handler**, можно [тут](#dostupnost-dopolnitel-nyh-protokolow-w-zawisimosti-ot-tochek-wstraiwaniq).

 Пример сообщения `Change` cмотрите в правой части экрана. 
 
 Здесь `changeHints` представляет собой массив с подсказками о том, что именно было изменено в редактируемом объекте:
                                        
- `_fields` — стандартные простые и ссылочные поля объекта (название, даты, контрагент и т. п.);  
- `positions` — позиции документа;
- `attributes` — значения дополнительных полей объекта. 
 
 Поле `objectState` — измененное состояние объекта, которое представляет собой JavaScript-объект, соответствующий по структуре ответу JSON API 1.2 на получение того же объекта (документа) с позициями.
 
 Несмотря на то, что структура `objectState` в целом соответствует JSON API 1.2, имеются расхождения:
 
- Поля, обязательные в JSON API 1.2, могут быть не заданы в несохраненном состоянии документа. В качестве значение таких полей в `objectState` передается `null`.
- Числовые поля, которые могут иметь разные типы (целочисленные и с плавающей точкой) в JSON API 1.2, в `objectState` имеют один и тот же тип  [Number](https://developer.mozilla.org/ru/docs/Glossary/Number). Это связано с тем, что `objectState` передается не как JSON, а как JavaScript Object.
- В `objectState` передается документ со всеми позициями, что в целом соответствует  запросу в JSON API c `expand=positions`. При этом в метаданных позиций документа всегда `offset=0`, а `limit` зависит от  `size`: `limit=1000`, если `size <= 1000` и `limit=size` если `size > 1000`.
- В objectState учитывается URL сервиса — [МойСклад](https://online.moysklad.ru) или [Моя Торговля](https://online.sb-mt.ru).
- В дополнительных полях типа Файл в `value` содержится имя файла с расширением, в отличие от JSON API 1.2.
- На страницах создания (точка расширения `*.create`) часть полей, которые заполняются после первого сохранения документа, могут быть не заполнены — иметь значение `null`:
  - `id`, `accountId`, `created`, `meta`, `href`, `uuidHref` для документа;
  - `externalCode` для документа, кроме Заказа покупателя, где внешний код может быть заполнен пользователем;
  - `id`, `accountId`, `meta`, `href`, `uuidHref` для позиций документа.
- на страницах создания некоторые поля могут иметь другое значение:
  - `updated` — заполняется временем открытия страницы документа.

  
 Актуальные сведения о поддержке конкретных полей документов в протоколе **change-handler** смотрите в документации JSON API 1.2:

- [Заказ покупателя](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-zakaz-pokupatelq)
- [Оприходование](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-oprihodowanie)
- [Отгрузка](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-otgruzka)
- [Приемка](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-priemka)
- [Перемещение](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-peremeschenie)
- [Списание](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-spisanie)
- [Счет покупателю](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-schet-pokupatelu)
- [Счет поставщика](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-schet-postawschika)
- [Возврат покупателя](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-vozwrat-pokupatelq)
- [Розничная продажа](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-roznichnaq-prodazha)

 > Сообщение Change
 
 ```json
{
  "name": "Change",
  "extensionPoint": "document.customerorder.edit",
  "messageId": 7,
  "changeHints": [
    "positions",
    "_fields"
  ],
  "objectState": {
    "meta": {
      "href": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/c4c6e6ea-b3f5-11eb-0a80-35ed000000b8",
      "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/metadata",
      "type": "customerorder",
      "mediaType": "application/json",
      "uuidHref": "https://online.moysklad.ru/app/#customerorder/edit?id=c4c6e6ea-b3f5-11eb-0a80-35ed000000b8"
    },
    "id": "c4c6e6ea-b3f5-11eb-0a80-35ed000000b8",
    "accountId": "5fc956ad-b3f2-11eb-0a80-1b8a00000000",
    "created": "2021-05-13 17:16:11.465",
    "payedSum": 0,
    "shippedSum": 0,
    "invoicedSum": 0,
    "name": "00001",
    "applicable": true,
    "moment": "2021-05-13 17:15:00.000",
    "store": {
      "meta": {
        "href": "https://api.moysklad.ru/api/remap/1.2/entity/store/605491e4-b3f2-11eb-0a80-35ed00000074",
        "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/store/metadata",
        "type": "store",
        "mediaType": "application/json",
        "uuidHref": "https://online.moysklad.ru/app/#warehouse/edit?id=605491e4-b3f2-11eb-0a80-35ed00000074"
      }
    },
    "rate": {
      "currency": {
        "meta": {
          "href": "https://api.moysklad.ru/api/remap/1.2/entity/currency/6055a619-b3f2-11eb-0a80-35ed00000079",
          "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/currency/metadata",
          "type": "currency",
          "mediaType": "application/json",
          "uuidHref": "https://online.moysklad.ru/app/#currency/edit?id=6055a619-b3f2-11eb-0a80-35ed00000079"
        }
      }
    },
    "organization": {
      "meta": {
        "href": "https://api.moysklad.ru/api/remap/1.2/entity/organization/6051401c-b3f2-11eb-0a80-35ed00000072",
        "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/organization/metadata",
        "type": "organization",
        "mediaType": "application/json",
        "uuidHref": "https://online.moysklad.ru/app/#mycompany/edit?id=6051401c-b3f2-11eb-0a80-35ed00000072"
      }
    },
    "agent": {
      "meta": {
        "href": "https://api.moysklad.ru/api/remap/1.2/entity/counterparty/60550738-b3f2-11eb-0a80-35ed00000077",
        "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/counterparty/metadata",
        "type": "counterparty",
        "mediaType": "application/json",
        "uuidHref": "https://online.moysklad.ru/app/#company/edit?id=60550738-b3f2-11eb-0a80-35ed00000077"
      }
    },
    "state": {
      "meta": {
        "href": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/metadata/states/60850d6a-b3f2-11eb-0a80-35ed00000097",
        "type": "state",
        "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/metadata",
        "mediaType": "application/json"
      }
    },
    "externalCode": "JAGi0Yg0i0OYvylp7SzDi3",
    "vatEnabled": true,
    "vatIncluded": true,
    "vatSum": 0,
    "sum": 21000,
    "updated": "2021-05-13 17:16:11.434",
    "reservedSum": 20000,
    "attributes": [
      {
        "meta": {
          "href": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/metadata/attributes/14fb3ad9-b3f6-11eb-0a80-35ed000000cb",
          "type": "attributemetadata",
          "mediaType": "application/json"
        },
        "id": "14fb3ad9-b3f6-11eb-0a80-35ed000000cb",
        "name": "Строка",
        "type": "string",
        "value": "123АААББвQ"
      },
      {
        "meta": {
          "href": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/metadata/attributes/14fbcb79-b3f6-11eb-0a80-35ed000000cc",
          "type": "attributemetadata",
          "mediaType": "application/json"
        },
        "id": "14fbcb79-b3f6-11eb-0a80-35ed000000cc",
        "name": "Ссылка",
        "type": "link",
        "value": null
      },
      {
        "meta": {
          "href": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/metadata/attributes/14fbd363-b3f6-11eb-0a80-35ed000000cd",
          "type": "attributemetadata",
          "mediaType": "application/json"
        },
        "id": "14fbd363-b3f6-11eb-0a80-35ed000000cd",
        "name": "Компания",
        "type": "counterparty",
        "value": {
          "meta": {
            "href": "https://api.moysklad.ru/api/remap/1.2/entity/counterparty/6054e7f9-b3f2-11eb-0a80-35ed00000075",
            "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/counterparty/metadata",
            "type": "counterparty",
            "mediaType": "application/json",
            "uuidHref": "https://online.moysklad.ru/app/#company/edit?id=6054e7f9-b3f2-11eb-0a80-35ed00000075"
          },
          "name": "ООО \"Поставщик\""
        }
      }
    ],
    "positions": {
      "meta": {
        "href": "https://api.moysklad.ru/api/remap/1.2/entity/customerorder/c4c6e6ea-b3f5-11eb-0a80-35ed000000b8/positions",
        "type": "customerorderposition",
        "mediaType": "application/json",
        "size": 2,
        "limit": 1000,
        "offset": 0
      },
      "rows": [
        {
          "meta": {
            "href": null,
            "type": "customerorderposition",
            "mediaType": "application/json"
          },
          "id": null,
          "accountId": "5fc956ad-b3f2-11eb-0a80-1b8a00000000",
          "price": 10000,
          "quantity": 2,
          "reserve": 2,
          "shipped": 0,
          "assortment": {
            "meta": {
              "href": "https://api.moysklad.ru/api/remap/1.2/entity/product/788a1cc7-b3f6-11eb-0a80-35ed000000e2",
              "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/product/metadata",
              "type": "product",
              "mediaType": "application/json",
              "uuidHref": "https://online.moysklad.ru/app/#good/edit?id=78896bd4-b3f6-11eb-0a80-35ed000000e0"
            }
          },
          "vat": 0,
          "discount": 0
        },
        {
          "meta": {
            "href": null,
            "type": "customerorderposition",
            "mediaType": "application/json"
          },
          "id": null,
          "accountId": "5fc956ad-b3f2-11eb-0a80-1b8a00000000",
          "price": 1000,
          "quantity": 1,
          "shipped": 0,
          "assortment": {
            "meta": {
              "href": "https://api.moysklad.ru/api/remap/1.2/entity/service/9d0c9a63-b3f6-11eb-0a80-35ed000000eb",
              "metadataHref": "https://api.moysklad.ru/api/remap/1.2/entity/service/metadata",
              "type": "service",
              "mediaType": "application/json",
              "uuidHref": "https://online.moysklad.ru/app/#good/edit?id=9d0c74c3-b3f6-11eb-0a80-35ed000000e9"
            }
          },
          "vat": 0,
          "discount": 0
        }
      ]
    }
  }
}

 ```

#### Валидация состояния редактируемого объекта

Виджет может проверять состояние редактируемого объекта и запрещать хост-окну сохранять объект, если он невалиден. Для этого в дескрипторе для виджета нужно объявить поддержку опционального протокола **validation-feedback**, который является параметром тега `change-handler`.

> Тег дополнительных протоколов supports с протоколом change-handler

  ```xml
      <supports>
        <change-handler>
          <validation-feedback/>
        </change-handler>
      </supports>
  ```
Протокол работает в паре с `change-handler`, то есть виджет, поддерживающий протокол `validation-feedback`, должен отправить сообщение `ValidationFeedback` о валидности документа в ответ на сообщение `Change`.

Если виджет в сообщении `ValidationFeedback` укажет, что документ невалиден, то при попытке сохранить документ пользователь увидит сообщение об ошибке, которое включает в себя наименование виджета.

![useful image](validation-feedback.png)

Если виджет по какой-то причине не отправит `ValidationFeedback` или отправит некорректное сообщение, пользователь не сможет сохранить документ. 

Подробнее о том, для каких точек поддерживается протокол **validation-feedback**, смотрите [здесь](#dostupnost-dopolnitel-nyh-protokolow-w-zawisimosti-ot-tochek-wstraiwaniq).

Пример сообщений `ValidationFeedback` cмотрите в правой части экрана.

Здесь:

- `messageId` — целочисленный идентификатор сообщения, уникальный в рамках текущего взаимодействия виджет — хост-окно. Назначается виджетом;
- `correlationId` — идентификатор соответствующего сообщения `Change`;
- `valid` — признак валидности документа;
- `message` — сообщение об ошибке. Требуется для случая когда `valid=false`. Максимум 100 символов.

> Сообщение ValidationFeedback — документ валиден (может быть сохранен)

 ```json
{
  "name": "ValidationFeedback",
  "messageId": 11,
  "correlationId": 10,
  "valid": true
}
```

> Сообщение ValidationFeedback — документ невалиден (не должен быть сохранен)

 ```json
{
  "name": "ValidationFeedback",
  "messageId": 12,
  "correlationId": 11,
  "valid": false,
  "message": "Пример ошибки от разработчика"
}
```


#### Изменение состояния редактируемого объекта

> Тег дополнительных протоколов supports с протоколом update-provider

  ```xml
      <supports>
          <update-provider/>
      </supports>
  ```

Виджет может изменять поля текущего редактируемого объекта посредством передачи сообщения `UpdateRequest` хост-окну.
Для этого в дескрипторе для виджета нужно объявить поддержку опционального протокола **update-provider**.

Изменения в этом протоколе, в отличие от JSON API, происходят без сохранения состояния объекта в базе данных МоегоСклада, так же, как если бы они были сделаны самим пользователем. Виджет должен отправлять сообщения `UpdateRequest` преимущественно в качестве реакции на действия пользователя, чтобы предупредить его об изменениях в редактируемом документе.

> Сообщение UpdateRequest

```json
{
  "name": "UpdateRequest",
  "messageId": 10,
  "updateState": {
    "name": "1",
    "deliveryPlannedMoment": "2021-08-21T12:15:50.333Z",
    "applicable": true,
    "description": null
  }
}
```

Сценарий работы:

1. Виджет отправляет хост-окну сообщение `UpdateRequest`, содержащее набор полей документа и/или позиции документа, которые нужно изменить.
2. Хост-окно валидирует содержимое сообщения и отправляет обратно ответ `UpdateRequest`.
3. Если сообщение `UpdateRequest` невалидно, хост-окно отправляет в ответ сообщение `InvalidMessageError`, содержащее описание ошибочных полей.


Примеры сообщений `UpdateRequest` смотрите в правой части экрана.

Здесь:

- `messageId` — целочисленный идентификатор сообщения, уникальный в рамках текущего взаимодействия виджет — хост-окно. Назначается виджетом;
- `updateState` — список полей, которые необходимо изменить. Соответствует телу запроса для обновления соответствующего документа в JSON API, смотрите, например, [Заказ покупателя](https://dev.moysklad.ru/doc/api/remap/1.2/documents/#dokumenty-zakaz-pokupatelq-izmenit-zakaz-pokupatelq).


Пример сообщения `UpdateResponse` смотрите в правой части экрана.

> Сообщение UpdateResponse

```json
{
  "name": "UpdateResponse",
  "correlationId": 10
}
```
Здесь:

- `correlationId` — идентификатор соответствующего сообщения `UpdateRequest`.

> Сообщение UpdateRequest для изменения дополнительных полей

```json
{
  "name":"UpdateRequest",
  "messageId":10,
  "updateState":{
    "description": "красивое",
    "attributes":[
      {
        "meta":{
          "href":"https://api.moysklad.ru/api/remap/1.2/entity/customerorder/metadata/attributes/f6d39a2b-146f-11ec-0a80-072a002cf678",
          "type":"attributemetadata"
        },
        "name":"Доставлено в срок",
        "type":"boolean",
        "value":true
      },
      {
        "id":"f6d39d12-146f-11ec-0a80-072a002cf679",
        "name":"Срок доставки, дней",
        "type":"long",
        "value":10
      },
      {
        "id":"f6d39d12-146f-11ec-0a80-072a002cf678",
        "value":45.78
      }
    ]
  }
}
```

> Сообщение UpdateRequest для добавления позиций

```json
{
  "name":"UpdateRequest",
  "messageId":10,
  "updateState":{
    "vatIncluded": true,
    "positions": [
      {
        "quantity": 10,
        "price": 100,
        "discount": 0,
        "vat": 0,
        "assortment": {
          "meta": {
            "href": "https://api.moysklad.ru/api/remap/1.2/entity/product/8b382799-f7d2-11e5-8a84-bae5000003a5",
            "type": "product"
          }
        },
        "reserve": 10
      },
      {
        "quantity": 1,
        "price": 200,
        "assortment": {
          "meta": {
            "href": "https://api.moysklad.ru/api/remap/1.2/entity/service/be903062-f504-11e5-8a84-bae50000019a",
            "type": "service"
          }
        },
        "pack": null
      },
      {
        "quantity": 30,
        "price": 300,
        "discount": 0,
        "vat": 18,
        "assortment": {
          "meta": {
            "href": "https://api.moysklad.ru/api/remap/1.2/entity/bundle/c02e3a5c-007e-11e6-9464-e4de00000006",
            "type": "bundle"
          }
        },
        "pack": {
          "id": "1bf22e62-8b47-11e8-56c0-000800000006"
        },
        "reserve": 30
      }
    ]
  }
}
```

> Сообщение UpdateRequest для изменения существующих позиций

```json
{
  "name":"UpdateRequest",
  "messageId":10,
  "updateState":{
    "vatIncluded": true,
    "positions": [
      {
        "id": "be903062-f504-11e5-8a84-bae50000019a",
        "price": 100,
        "discount": -10
      },
      {
        "id": "be903062-f504-11e5-8a84-bae500000123",
        "quantity": 30,
        "price": 300,
        "discount": 0,
        "vat": 18,
        "assortment": {
          "meta": {
            "href": "https://api.moysklad.ru/api/remap/1.2/entity/bundle/c02e3a5c-007e-11e6-9464-e4de00000006",
            "type": "bundle"
          }
        },
        "reserve": 30
      }
    ]
  }
}
```

> Сообщение UpdateRequest для добавления одной новой и сохранения трех  существующих позиций

```json
{
  "name":"UpdateRequest",
  "messageId":10,
  "updateState":{
    "vatIncluded": true,
    "positions": [
      {
        "id": "be903062-f504-11e5-8a84-bae50000019a"
      },
      {
        "id": "0fb51a51-e01d-48da-9035-4b21f5e69055"
      },
      {
        "id": "ef34072d-5fd3-4ac4-b4b9-87458ca61da2"
      },
      {
        "quantity": 1,
        "price": 300,
        "assortment": {
          "meta": {
            "href": "https://api.moysklad.ru/api/remap/1.2/entity/service/c02e3a5c-007e-11e6-9464-e4de00000006",
            "type": "service"
          }
        }
      }
    ]
  }
}
```

**Работа с полями из `updateState`**:

* Список может содержать одно или несколько полей для изменения.
* При изменении значения поля на то же самое, поле в интерфейсе не обновляется и документ не считается измененным. То есть пользователь может закрыть экран редактирования документа без диалога с вопросом «Данные были изменены. Сохранить изменения?». К позициям это не относится: если позиции в запросе есть, список всегда обновляется и документ считается измененным.
* Содержимое поля можно сбросить, указав в качестве его значения `null`. 
* Если пришло несколько сообщений подряд, все они обрабатываются последовательно.
* Поля типа **Дата-время** необходимо передавать с включением информации о часовом поясе, чтобы избежать неопределенности в интерпретации.
* Значения полей типа **Дата-время** всегда округляются до минут, секунды отбрасываются.
* Для значений ссылочных полей обязательными являются `meta.href` и `meta.type`, остальные поля внутри `meta` игнорируются.
* Для одновременного изменения согласованных полей, таких как Организация (Контрагент), Счет, Договор, необходимо, чтобы их значения были совместимы. Счет должен принадлежать указанной организации, договор должен относиться к этой организации и контрагенту. Иначе возникнет ошибка валидации и значения полей в интерфейсе не изменятся.

**Работа с дополнительными полями (attributes)**:

* Для идентификации дополнительного поля необходимо указать `meta.href` либо `id`. Если указаны оба поля, значение берется из `meta.href`.
* Для передачи значения поля служит поле `value`.
* Остальные поля не являются обязательными.
* Пока не поддерживаются дополнительные поля типа Файл.

**Работа с позициями (positions)**:

* При указании позиций в сообщении `UpdateRequest` существующие позиции в документе полностью заменяются позициями из сообщения.
* Для редактирования позиции необходимо использовать `id` существующей позиции, например, получив их в сообщении `Change` или через JSON API.
* При необходимости добавить новые позиции с сохранением существующих можно указать `id` существующих позиций и новые позиции. В результате останутся существующие позиции и добавятся новые.
* До сохранения документа в базе данных у новых позиций отсутствует `id`.
* Позиции добавляются в порядке, который указан в сообщении.

Подробнее о том, для каких точек поддерживается протокол **update-provider**, смотрите в [статье](#dostupnost-dopolnitel-nyh-protokolow-w-zawisimosti-ot-tochek-wstraiwaniq).

### Кастомные модальные окна

> Дескриптор с виджетом и iframe-частью, использующие кастомные модальные окна

```xml
<ServerApplication  xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"             
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"             
                    xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2      
                    https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
    <iframe>
        <sourceUrl>https://example.com/iframe.html</sourceUrl>
        <expand>true</expand>
    </iframe>
    <vendorApi>
        <endpointBase>https://example.com/dummy-app</endpointBase>
    </vendorApi>
    <access>
        <resource>https://api.moysklad.ru/api/remap/1.2</resource>
        <scope>admin</scope>
    </access>
    <widgets>        
        <entity.counterparty.edit>            
            <sourceUrl>https://example.com/widget.php</sourceUrl>            
            <height>                
                <fixed>150px</fixed>            
            </height>
            <uses>
                <good-folder-selector/>
            </uses>                  
        </entity.counterparty.edit>    
    </widgets>
    <popups>
        <popup>
            <name>somePopup</name>
            <sourceUrl>https://example.com/popup.php</sourceUrl>
        </popup>
        <popup>
            <name>somePopup2</name>
            <sourceUrl>https://example.com/popup-2.php</sourceUrl>
        </popup>
    </popups>
</ServerApplication>
```
> Сообщение ShowPopupRequest

```json 
{
  "name": "ShowPopupRequest",
  "messageId": 12,
  "popupName": "somePopup",
  "popupParameters": "hello"
}
```

> Сообщение OpenPopup

```json 
{
  "name": "OpenPopup",
  "messageId": 36,
  "popupName": "somePopup",
  "popupParameters": "hello"
}
```

> Сообщение ClosePopup

```json 
{
  "name": "ClosePopup",
  "messageId": 17,
  "popupResponse": "world"
}
```

> Сообщение ShowPopupResponse

```json 
{
  "name": "ShowPopupResponse",
  "correlationId": 12,
  "popupName": "somePopup",
  "popupResolution": "normal",
  "popupResponse": "world"
}
```

Модальные окна позволяют расширить функциональность iframe-части решения, виджетов или кастомных кнопок. 

Характеристики кастомного модального окна:

* Открывается на весь экран аналогично прочим модальным окнам в интерфейсе МоегоСклада. Например, вызываемое через иконку «карандаш» окно редактирования сущностей в полях.
* Является модальным, то есть открывается поверх текущей страницы МоегоСклада, и требует действия от пользователя внутри этого окна — взаимодействия с веб-страницей и/или закрытие окна.
* Содержимое окна определяет разработчик. Передавать данные можно от виджета и iframe-части в модальное окно и в обратном направлении. 
* Может получать текущий контекст пользователя, так же как виджеты и основная iframe-часть решения.
* В качестве заголовка окна всегда используется название решения.
* Имеет кнопку принудительного закрытия для пользователя — «крестик» справа вверху.
* Изменяет свои размеры при изменении размеров окна браузера.

Рассмотрим работу кастомных модальных окон на примере виджетов. В случае iframe-части все работает аналогично. 
Отличия при вызове окна из кастомных кнопок будут описаны ниже. 

Чтобы решение могло использовать кастомные модальные окна, добавьте в [дескриптор решения](#blok-popups) блок `<popups>...</popups>`.
Пример дескриптора смотрите в правой части экрана.

Виджет может отобразить одно из кастомных модальных окон, отправив сообщение `ShowPopupRequest` с именем выбранного окна хост-окну. Пример такого сообщения смотрите в правой части экрана. 

Здесь:

* `messageId` — идентификатор сообщения;
* `popupName` — имя открываемого окна;
* `popupParameters` — опциональные параметры, передаваемые окну виджетом. Может иметь любой тип, в том числе `null`.

МойСклад проверяет сообщение `ShowPopupRequest`. Если сообщение валидно, отображается модальное окно: загружается страница окна по адресу `sourceUrl` в iframe, в GET-параметре передается `contextKey`. Процесс аналогичен загрузке виджета. Значение `sourceUrl` загружается из соответствующего элемента списка модальных окон `<popups>` в дескрипторе. Поиск производится по `popupName`, переданному в сообщении.

После загрузки модального окна хост-окно отправляет ему сообщение `OpenPopup`. Набор полей тот же, что и в `ShowPopupRequest`.
При этом `messageId` в данном сообщении свой, а не тот, что был передан в сообщении `ShowPopupRequest`.
  
Для закрытия модального окна, оно отправляет сообщение `ClosePopup` хост-окну. Пример такого сообщения смотрите в правой части экрана. 

Здесь:

* `messageId` — идентификатор сообщения;
* `popupResponse` — опциональный ответ, возвращаемый виджету. Может иметь любой тип, в том числе `null`.

МойСклад, в свою очередь, отправляет сообщение `ShowPopupResponse` виджету, открывшему окно. Пример такого сообщения смотрите в правой части экрана. 

Здесь:

* `correlationId` — идентификатор соответствующего сообщения ShowPopupRequest;
* `popupName` — имя открывавшегося модального окна;
* `popupResolution` — вариант, по которому произошло закрытие модального окна:
                      `normal` — нормальное закрытие окна по `ClosePopup`,
                      `closedByUser` — закрытие окна пользователем путем нажатия на «крестик»;
* `popupResponse` — опциональный ответ, возвращаемый виджету.

Страницы кастомных модальных окон кэшируются аналогично кэшированию виджетов. При повторном открытии окна по сообщению `ShowPopupRequest` переиспользуется ранее загруженный iframe. 

Ниже приводятся примеры работы с кастомными модальными окнами.

#### Пример работы без возврата параметров из модального окна 

> Пример взаимодействия без передачи дополнительных параметров

```json 
// виджет -> хост-окно
{
  "name": "ShowPopupRequest",
  "messageId": 12,
  "popupName": "somePopup"
}

// хост-окно -> модальное окно
{
  "name": "OpenPopup",
  "messageId": 35,
  "popupName": "somePopup"
}

// хост-окно -> виджет
{
  "name": "ShowPopupResponse",
  "correlationId": 12,
  "popupName": "somePopup",
  "popupResolution": "closedByUser"
}
```

> Пример взаимодействия с передачей параметров в виде строки

```json 
// виджет -> хост-окно
{
  "name": "ShowPopupRequest",
  "messageId": 17,
  "popupName": "somePopup",
  "popupParameters": "hello"
}

// хост-окно -> модальное окно
{
  "name": "OpenPopup",
  "messageId": 36,
  "popupName": "somePopup",
  "popupParameters": "hello"
}

// хост-окно -> виджет
{
  "name": "ShowPopupResponse",
  "correlationId": 17,
  "popupName": "somePopup",
  "popupResolution": "closedByUser"
}
```

1. Виджет отправляет хост-окну сообщение `ShowPopupRequest`. В сообщении указывается имя модального окна и опциональные параметры.
2. Хост-окно отображает модальное окно, загружая страницу окна по адресу `sourceUrl` в iframe с передачей `contextKey` в GET-параметре.
3. Хост-окно отправляет в iframe модального окна сообщение `OpenPopup`, передавая в нем опциональные параметры от виджета.
4. Пользователь взаимодействует с веб-содержимым модального окна, после чего закрывает его через системную кнопку («крестик»), находящуюся в верхнем правом углу окна.
5. Система скрывает модальное окно и отправляет виджету сообщение `ShowPopupResponse` с указанием того, что окно было закрыто пользователем через системную кнопку (```"popupResolution": "closedByUser"```).

Пример модального окна с наличием только системной кнопки закрытия:

![useful image](popup-view.png)

> Закрытие модального окна с использованием сообщения ClosePopup

```json 
...
// модальное окно -> хост-окно
{
  "name": "ClosePopup",
  "messageId": 37,
}

// хост-окно -> виджет
{
  "name": "ShowPopupResponse",
  "correlationId": 14,
  "popupName": "somePopup",
  "popupResolution": "normal"
}
```

Разработчик может отобразить на странице и собственную кнопку закрытия окна. При нажатии на нее будет отправляться сообщение `ClosePopup`, а виджет получит сообщение `ShowPopupResponse` с  ```"popupResolution": "normal"```.

![useful image](popup-view-button.png)


#### Пример работы с возвратом параметров из модального окна 

> Пример ответа с передачей данных о нажатой кнопке

```json 
// виджет -> хост-окно
{
  "name": "ShowPopupRequest",
  "messageId": 29,
  "popupName": "somePopup"
}

// хост-окно -> модальное окно
{
  "name": "OpenPopup",
  "messageId": 36,
  "popupName": "somePopup"
}

// пользователь нажимает на кнопку «Сохранить»

// модальное окно -> хост-окно
{
  "name": "ClosePopup",
  "messageId": 44,
  "popupResponse": "save"
}

// хост-окно -> виджет
{
  "name": "ShowPopupResponse",
  "correlationId": 29,
  "popupName": "somePopup",
  "popupResolution": "normal",
  "popupResponse": "save"
}
```
Если модальному окну требуется вернуть информацию обратно в виджет, окно должно передать ее в поле `popupResponse` сообщения `ClosePopup`.

1. Виджет отправляет хост-окну сообщение `ShowPopupRequest`, указывая в нем имя модального окна и опциональные параметры.
1. Хост-окно отображает модальное окно, загружая его страницу по адресу `sourceUrl` в iframe с передачей `contextKey` в GET-параметре.
1. Хост-окно отправляет в iframe модального окна сообщение `OpenPopup` с опциональными параметрами.
1. Пользователь взаимодействует с веб-содержимым модального окна, после чего нажимает кнопку закрытия или сохранения, находящуюся внутри страницы модального окна.
1. Модальное окно отправляет хост-окну сообщение `ClosePopup`. В нем передаются параметры, которые зависят от действий пользователя, например тип нажатой кнопки. 
1. Система скрывает модальное окно и отправляет виджету сообщение `ShowPopupResponse` с указанием параметров, переданных модальным окном.

Пользователь может закрыть модальное окно принудительно. При этом параметры в виджет не будут переданы.

Пример модального окна с кнопками «Сохранить» и «Отмена»:

![useful image](popup-edit.png)

#### Отображение содержимого, которое не вмещается в окно целиком

> Пример плавающей верстки содержимого

```html
<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">

    <title>Popup example</title>
    <style>
        body {
            overflow: hidden;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .content-container {
            overflow: auto;
            flex-grow: 1;
        }
        .buttons-container {
            padding-top: 15px;
            min-height: 55px;
        }
    </style>
    <link rel="stylesheet" href="css/uikit.css">
</head>

<body>
<div class="main-container">
    <div class="content-container">
        <!--Разместите содержимое здесь -->
    </div>
    <div class="buttons-container">
        <button class="button button--success">Сохранить</button>
        <button class="button">Отмена</button>
    </div>
</div>
</body>
</html>
```

Если во модальном окне нужно отобразить содержимое, которое может не поместиться на экране пользователя, используйте плавающую верстку. Так вы можете создать полосы прокрутки для содержимого, и кнопки закрытия окна всегда будут отображаться в нижней части окна. 

Пример модального окна с полосами прокрутки:

![useful image](popup-scroll.png)

Пример такой верстки с использованием [UI Kit](https://github.com/moysklad/html-marketplace-1.0-uikit) представлен справа.


#### Способы передачи параметров  

> Пример взаимодействия с передачей параметров в виде строки

```json 
// виджет -> хост-окно
{
  "name": "ShowPopupRequest",
  "messageId": 12,
  "popupName": "somePopup",
  "popupParameters": "hello"
}

// хост-окно -> модальное окно
{
  "name": "OpenPopup",
  "messageId": 35,
  "popupName": "somePopup",
  "popupParameters": "hello"
}
```

> Пример взаимодействия с передачей параметров в виде объекта

```json 
// виджет -> хост-окно
{
  "name": "ShowPopupRequest",
  "messageId": 12,
  "popupName": "somePopup",
  "popupParameters": {
    "aaa": 1,
    "bbb": "qwerty"
  }
}

// хост-окно -> модальное окно
{
  "name": "OpenPopup",
  "messageId": 35,
  "popupName": "somePopup",
  "popupParameters": {
    "aaa": 1,
    "bbb": "qwerty"
  }
}
```     

> Пример взаимодействия с передачей параметров в виде массива

```json 
// виджет -> хост-окно
{
  "name": "ShowPopupRequest",
  "messageId": 12,
  "popupName": "somePopup",
  "popupParameters": [123, "foobar"]
}

// хост-окно -> модальное окно
{
  "name": "OpenPopup",
  "messageId": 35,
  "popupName": "somePopup",
  "popupParameters": [123, "foobar"]
}
```

Существует несколько способов передачи параметров между виджетами и модальными окнами:

* передача в виде примитивного значения;
* передача в виде объекта;
* передача в виде массива, в том числе массива объектов;
* передача в виде значения `null`.

Справа приведены примеры передачи параметров из виджета в модальное окно через сообщение `ShowPopupRequest`.

Аналогичные способы передачи можно использовать для возврата ответа в сообщении `ClosePopup`.

#### Вызов модального окна из кастомной кнопки

Кнопка может отобразить одно из модальных окон решения, отправив в ответе на [запрос обработки нажатия на кнопку](#obrabotka-nazhatiq-na-kastomnuu-knopku) значение `action=ShowPopup` с именем выбранного окна и опциональными параметрами. 

Если такое окно описано в дескрипторе решения, то, как и для вызова через сообщение, оно загружается (с передачей `contextKey`) или берется из кэша.
После загрузки модального окна хост-окно отправляет ему сообщение `OpenPopup` и передает опциональные параметры, полученные в запросе.

По окончании работы с модальным окном пользователь может закрыть его через системную кнопку либо само окно может отправить сообщение `ClosePopup`.  

Отличия при работе с модальными окнами, вызванными по нажатию кастомной кнопки:

* нет взаимодействия с хост-окном (не используются сообщения `ShowPopupRequest` и `ShowPopupResponse`)

### Сервисы хост-окна

В виджетах, iframe и модальных окнах доступны следующие сервисные возможности МоегоСклада (хост-окна):

* [Селектор группы товаров](#selektor-gruppy-towarow),
* [Стандартные диалоги](#standartnye-dialogi),
* [Протокол навигации](#protokol-nawigacii).

#### Селектор группы товаров

> Дескриптор решения с виджетом, использующим селектор группы товаров

```xml
<ServerApplication  xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"             
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"             
                    xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2      
                    https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
    <iframe>
        <sourceUrl>https://example.com/iframe.html</sourceUrl>
        <expand>true</expand>
    </iframe>
    <vendorApi>
        <endpointBase>https://example.com/dummy-app</endpointBase>
    </vendorApi>
    <access>
        <resource>https://api.moysklad.ru/api/remap/1.2</resource>
        <scope>admin</scope>
    </access>
    <widgets>        
        <entity.counterparty.edit>            
            <sourceUrl>https://example.com/widget.php</sourceUrl>            
            <height>                
                <fixed>150px</fixed>            
            </height>
            <uses>
                <good-folder-selector/>
            </uses>                  
        </entity.counterparty.edit>    
    </widgets>
</ServerApplication>
```

> Дескриптор решения, iframe-часть и модальное окно которого используют селектор группы товаров

```xml
<ServerApplication xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2      
                    https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
  <iframe>
    <sourceUrl>https://example.com/iframe.html</sourceUrl>
    <expand>true</expand>
    <uses>
      <good-folder-selector/>
    </uses>
  </iframe>
  <vendorApi>
    <endpointBase>https://example.com/dummy-app</endpointBase>
  </vendorApi>
  <access>
    <resource>https://api.moysklad.ru/api/remap/1.2</resource>
    <scope>admin</scope>
  </access>
  <popups>
    <popup>
      <name>coolPopup</name>
      <sourceUrl>https://vendorurl.coolpopup.ru</sourceUrl>
      <uses>
        <good-folder-selector/>
      </uses>
    </popup>
  </popups>
</ServerApplication>
```
Позволяет виджетам, основной iframe-части и модальным окнам решений переиспользовать существующий в МоемСкладе селектор группы
товаров с получением ими результата выбора пользователя.

Чтобы виджет, iframe-часть или модальное окно начали поддерживать селектор в дескрипторе, необходимо добавить в блок `uses` для `widgets`, `iframe` или `popup` тег:
`<good-folder-selector/>`.

Рассмотрим пример с виджетом. Когда виджет отправляет хост-окну сообщение `SelectGoodFolderRequest` через Window.postMessage,
хост-окно запрашивает у пользователя выбор группы товаров, используя встроенный в МойСклад селектор:

![useful image](good-folder-selector.png)

> Cообщение SelectGoodFolderRequest

```json 
{
  "name": "SelectGoodFolderRequest",
  "messageId": 12345
}
```

Здесь:
- `messageId` — целочисленный идентификатор сообщения, уникальный в рамках текущего взаимодействия виджет — хост-окно. Назначается виджетом.

После совершения пользователем выбора группы товаров или отказа от него хост-окно передает виджету результат действий пользователя в сообщении `SelectGoodFolderResponse`.

> Cообщение SelectGoodFolderResponse (Пользователь выбрал группу товаров, имеющую идентификатор 8e9512f3-111b-11ea-0a80-02a2000a3c9c)

```json 
{
  "name": "SelectGoodFolderResponse",
  "correlationId": 12345,
  "selected": true,
  "goodFolderId": "8e9512f3-111b-11ea-0a80-02a2000a3c9c"
}
```

Здесь:

- `correlationId` — идентификатор соответствующего сообщения `SelectGoodFolderRequest`;
- `selected` — признак наличия выбора;
- `goodFolderId` — идентификатор выбранной группы товаров.

> Cообщение SelectGoodFolderResponse (Пользователь отменил выбор)

```json 
{
  "name": "SelectGoodFolderResponse",
  "correlationId": 12345,
  "selected": false
}
```

#### Стандартные диалоги

> Дескриптор с виджетом, использующим стандартные диалоги

```xml
<ServerApplication  xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"             
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"             
                    xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2      
                    https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
    <iframe>
        <sourceUrl>https://example.com/iframe.html</sourceUrl>
        <expand>true</expand>
    </iframe>
    <vendorApi>
        <endpointBase>https://example.com/dummy-app</endpointBase>
    </vendorApi>
    <access>
        <resource>https://api.moysklad.ru/api/remap/1.2</resource>
        <scope>admin</scope>
    </access>
    <widgets>        
        <entity.counterparty.edit>            
            <sourceUrl>https://example.com/widget.php</sourceUrl>            
            <height>                
                <fixed>150px</fixed>            
            </height>
            <uses>
                <standard-dialogs/>
            </uses>                  
        </entity.counterparty.edit>    
    </widgets>
</ServerApplication>
```

> Дескриптор решения, iframe-часть и модальное окно которого используют стандартные диалоги

```xml
<ServerApplication xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2      
                    https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
  <iframe>
    <sourceUrl>https://example.com/iframe.html</sourceUrl>
    <expand>true</expand>
    <uses>
        <standard-dialogs/>
    </uses>
  </iframe>
  <vendorApi>
    <endpointBase>https://example.com/dummy-app</endpointBase>
  </vendorApi>
  <access>
    <resource>https://api.moysklad.ru/api/remap/1.2</resource>
    <scope>admin</scope>
  </access>
  <popups>
    <popup>
      <name>coolPopup</name>
      <sourceUrl>https://vendorurl.coolpopup.ru</sourceUrl>
      <uses>
          <standard-dialogs/>
      </uses>
    </popup>
  </popups>
</ServerApplication>
```


Позволяет виджетам, основной iframe-части и кастомным модальным окнам использовать существующие в МоемСкладе стандартные диалоги.

Чтобы виджет, iframe или модальное окно начали поддерживать протокол, необходимо добавить в блок `uses` для `widgets`, `iframe` или `popup` тег:
`<standard-dialogs/>`.

Рассмотрим пример с виджетом. Когда виджет хочет показать пользователю стандартный диалог, он отправляет хост-окну сообщение `ShowDialogRequest`. В сообщении указывается текст сообщения и кнопки, которые необходимо отобразить пользователю. Наример:

![useful image](standard-dialog-with-two-buttons.png)


> Cообщение ShowDialogRequest

```json 
{
  "name": "ShowDialogRequest",
  "messageId": 12345,
  "dialogText": "Учетная запись будет удалена. Вы хотите продолжить?",
  "buttons": [
    {"name": "Yes", "caption": "Да, удалить"},
    {"name": "No", "caption": "Нет"}
  ]
}
```

Параметры сообщения `ShowDialogRequest`:

* `messageId` — целочисленный идентификатор сообщения, уникальный в рамках текущего взаимодействия виджет — хост-окно. Назначается виджетом;
* `dialogText` — текст сообщения, который нужно отобразить пользователю МоегоСклада. Максимальный размер — 4096 символов. HTML-теги не допускаются (будут экранированы);
* `buttons` — список кнопок в диалоге, элементами которого являются объекты с двумя обязательными полями: `name` — имя кнопки, будет возвращено в сообщении `ShowDialogResponse`, `caption` — текст, отображаемый на кнопке. Максимальный размер поля `caption` — 100 символов. HTML-теги в нем не допускаются (будут экранированы).

После того, как пользователь нажимает кнопку в диалоге или принудительно закрывает хост-окно (нажимает на «крестик»), результат действий пользователя возвращается в сообщении `ShowDialogResponse`.

> Сообщение ShowDialogResponse (Пользователь нажимает кнопку **Нет**)

```json 
{
  "name": "ShowDialogResponse",
  "correlationId": 12345,
  "buttonName": "No",
  "dialogResolution": "normal"
}
```

Параметры ответа `ShowDialogResponse`:

+ `correlationId` — идентификатор соответствующего сообщения `ShowDialogResponse`;
+ `dialogResolution` — признак выбора: `normal` — была нажата одна из кнопок, `closedByUser` — диалог был завершен принудительно;
+ `buttonName` — имя выбранной кнопки.

> Сообщение ShowDialogResponse (Пользователь закрыл диалог, нажав на «крестик»)

```json 
{
  "name": "ShowDialogResponse",
  "correlationId": 12345,
  "dialogResolution": "closedByUser"
}
```
**Примечание**:
В версии Google Chrome 92.0 и выше использование браузерных диалоговых окон через вызовы Window.alert(), Window.confirm() из iframe [запрещено](https://www.chromestatus.com/feature/5148698084376576).
Поэтому рекомендуется использовать сервис стандартных диалогов МоегоСклада.

#### Протокол навигации

> Дескриптор с виджетом, использующим протокол навигации

```xml
<ServerApplication  xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"             
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"             
                    xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2      
                    https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
    <iframe>
        <sourceUrl>https://example.com/iframe.html</sourceUrl>
        <expand>true</expand>
    </iframe>
    <vendorApi>
        <endpointBase>https://example.com/dummy-app</endpointBase>
    </vendorApi>
    <access>
        <resource>https://api.moysklad.ru/api/remap/1.2</resource>
        <scope>admin</scope>
    </access>
    <widgets>        
        <entity.counterparty.edit>            
            <sourceUrl>https://example.com/widget.php</sourceUrl>            
            <height>                
                <fixed>150px</fixed>            
            </height>
            <uses>
                <navigation-service/>
            </uses>                  
        </entity.counterparty.edit>    
    </widgets>
</ServerApplication>
```
> Дескриптор решения, у которого iframe-часть и модальное окно используют протокол навигации

```xml
<ServerApplication xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2      
                    https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
  <iframe>
    <sourceUrl>https://example.com/iframe.html</sourceUrl>
    <expand>true</expand>
    <uses>
      <navigation-service/>
    </uses>
  </iframe>
  <vendorApi>
    <endpointBase>https://example.com/dummy-app</endpointBase>
  </vendorApi>
  <access>
    <resource>https://api.moysklad.ru/api/remap/1.2</resource>
    <scope>admin</scope>
  </access>
  <popups>
    <popup>
      <name>coolPopup</name>
      <sourceUrl>https://vendorurl.coolpopup.ru</sourceUrl>
      <uses>
        <navigation-service/>
      </uses>
    </popup>
  </popups>
</ServerApplication>
```
Позволяет виджетам, iframe-части и модальным окнам решений осуществлять переход на другую страницу МоегоСклада и открывать МойСклад в новой вкладке.

Чтобы виджет, iframe или модальное окно начали поддерживать протокол навигации в дескрипторе необходимо добавить в блок `uses` для `widgets`, `iframe` или `popup` тег:
`<navigation-service/>`.
Примеры смотрите в правой части экрана.

Рассмотрим пример с виджетом. Когда виджет отправляет хост-окну сообщение `NavigateRequest` (через Window.postMessage), хост-окно переходит на другую страницу МоегоСклада или открывает в новой вкладке браузера нужную страницу МоегоСклада.

> Cообщение NavigateRequest

```json 
{
  "name": "NavigateRequest",
  "messageId": 12345,
  "path": "#good/edit?id=e8a46787-0ff4-11ec-0a80-1eb200000740",
  "target": "blank"
}
```
Параметры сообщения `NavigateRequest`:

* `messageId` — целочисленный идентификатор сообщения, уникальный в рамках текущего взаимодействия виджет — хост-окно. Назначается виджетом.
* `path` — путь до страницы, на которую виджет хочет осуществить переход. Например, чтобы осуществить переход пользователя на страницу реестра заказов покупателя https://online.moysklad.ru/app/#customerorder, нужно передать `#customerorder`.
* `target` — вид навигации. Может принимать одно из двух значений: `self` — переход в текущей вкладке, `blank` — открытие в новой вкладке.

Если валидация сообщения пройдет успешно, перед переходом пользователя будет отправлен `NavigateResponse` обратно в виджет.

> Cообщение NavigateResponse

```json 
{
  "name": "NavigateResponse",
  "correlationId": 12345 
}
```
Параметры ответа `NavigateResponse`:

+ `correlationId` — идентификатор соответствующего сообщения `NavigateRequest`.

При навигации из модального окна в текущей вкладке (`target` имеет значение `self`) произойдет переход, и модальное окно будет отображаться поверх страницы. Если необходимо, чтобы после перехода окно закрывалось, используйте сообщение `ClosePopup`. Подробнее смотрите в разделе [Кастомные модальные окна](#kastomnye-modal-nye-okna).

### Ошибки при работе с виджетами

При получении сообщения от виджета хост-окно производит валидацию сообщения. Если проверка не пройдена, хост-окно возвращает в ответ сообщение `InvalidMessageError` со списком ошибок.

> Пример сообщения InvalidMessageError

```json 
{
  "name": "InvalidMessageError",
  "correlationId": null,
  "invalidMessage": {
    "name": "SelectGoodFolderRequest"
  },
  "errors": [
    {
      "code": 1001,
      "error": "Отсутствует обязательный параметр messageId"
    }
  ]
}
```

Пример такого сообщения смотрите в правой части экрана.

Здесь:

+ `correlationId` — идентификатор сообщения, которое вызвало ошибку;
+ `invalidMessage` — исходное сообщение, которое вызвало ошибку;
+ `errors` — список ошибок, каждое из которых содержит поля:
    + `code` — код ошибки
    + `error` — описание ошибки.

Перечень возможных ошибок представлен в таблице.

| Код ошибки | Сообщение                                                                                                           | Описание                                                                                                                                                                                                    | Пример                                                                                            |
|------------|---------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| 1000       | Недопустимое состояние виджета %state% для сообщения %message.name%, допустимые состояния: %message.expectedStates% | Не допускается отправка данного сообщения из текущего состояния виджета                                                                                                                                     | `Недопустимое состояние виджета Opened для сообщения OpenFeedback, допустимые состояния: Opening` |
| 1001       | Отсутствует обязательный параметр %parameter.name%                                                                  | В сообщении отсутствует обязательный параметр                                                                                                                                                               | `Отсутствует обязательный параметр messageId`                                                     | 
| 1002       | Некорректное значение параметра %parameter.name%: %пояснение%                                                       | Параметр сообщения имеет некорректное значение                                                                                                                                                              | `Некорректное значение параметра popupName: popup with name = 'somePopup1' not found`             |
| 1003       | Параллельный запрос %message.name%                                                                                  | Не допускается отправка виджетом повторного запроса до момента получения ответа на предыдущий такой же запрос. Например: виджет уже отправил `SelectGoodFolderRequest` и пользователь еще не завершил выбор | `Параллельный запрос SelectGoodFolderRequest`                                                     |
| 1004       | Виджет не поддерживает протокол для обработки сообщения %message.name%                                              | Не допускается обработка сообщения в виджете, который не поддерживает протокол данного сообщения                                                                                                            | `Виджет не поддерживает протокол для обработки сообщения ShowDialogRequest`                       |


### Кастомные кнопки

> Дескриптор решения с двумя кнопками на странице Заказа покупателя

```xml
   <ServerApplication xmlns="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="https://apps-api.moysklad.ru/xml/ns/appstore/app/v2
         https://apps-api.moysklad.ru/xml/ns/appstore/app/v2/application-v2.xsd">
       <iframe>...</iframe>
       <vendorApi>...</vendorApi>
       <access>...</access>
        <buttons>
            <button name="button1" title="Отправить контрагенту">
                <locations>
                    <document.customerorder.edit/>
                </locations>
            </button>
            <button name="button2" title="Сформировать цифровую подпись">
                <locations>
                    <document.customerorder.create/>
                    <document.customerorder.edit/>
                </locations>
            </button>
        </buttons>
</ServerApplication>
```

Кастомные кнопки позволяют разработчику встраивать одну или несколько кнопок в меню Решения, расположенного на страницах интерфейса МоегоСклада.
Каждая кнопка отвечает за одно специфическое действие, инициируемое пользователем и выполняемое на сервере разработчика.

Кнопки можно встраивать как в карточку документа (сущности) так и в списки. 
В первом случае в контексте обработки нажатия придет идентификатор открытого объекта, во втором - список выделенных объектов и их тип.   

В списках пользователь вручную может выбрать до 100 объектов перед нажатием кнопки.
Если требуется выполнить действие для большего количества объектов, предусмотрен диалог подтверждения, 
в котором можно выбрать все объекты с учётом фильтров:

![useful image](confirm-click-button.png)

Примеры действий при нажатии на кастомную кнопку:

* Создать ссылку на оплату
* Проверить контрагента
* Открыть чат с клиентом
* Отправить выделенные документы в ЭДО

Для добавления кастомной кнопки необходимо заполнить [блок buttons](#blok-buttons) в дескрипторе решения и реализовать [эндпоинт обработчика нажатия на кнопку в vendorApi](#obrabotka-nazhatiq-na-kastomnuu-knopku).

Пример дескриптора решения с кнопками на странице Заказа покупателя расположен в правой части экрана.

Меню с кнопками появляется при нажатии на кнопку Решения:

![useful image](buttons.png)

Порядок отображения кнопок в меню соответствует имени решения (сортировка по алфавиту) и порядку задания кнопки в дескрипторе.

Если при нажатии на кастомную кнопку запускается асинхронная обработка, то при ее окончании пользователю будет выведено системное уведомление (которое также сохраняется в Ленте уведомлений):

Примеры уведомлений:

![useful image](async_buttons_1.png)

![useful image](async_buttons_2.png)
