## Общая информация

В данном разделе можно узнать:

- какие бывают приложения в Маркетплейсе
- варианты платности приложений
- как создать свое приложение

### Типы приложений в Маркетплейсе

Тип приложения определяет в первую очередь технический способ интеграции приложения с МоимСкладом.

Поддерживаемые на текущий момент типы приложений:

+ Телефония (Phone API)
+ Iframe-приложения
+ Серверные приложения
+ Интеграция с системами лояльности (Loyalty API)

### Сводная таблица поддержки функций для типов приложений

| Тип приложения | Количество приложений на аккаунте | Iframe и доступ к контексту пользователя | Активация и деактивация по Vendor API | Доступ по токену к JSON API 1.2 | Отладка на аккаунтах разработчика | Phone API | Loyalty API | Блок на витрине приложений | Виджеты 
|----|----|----|----|----|----|----|----|----|----|
|Телефония|1| | | |+|+| | Звонки | | 
|Iframe-приложения|Не ограничено|+|  | | + | | |Новые| |   
|Серверные приложения|Не ограничено|+|+|+|+| | |Новые|+|   
|Системы лояльности|1| | | | | |+|Скидки| |   



### Серверные приложения

Серверные приложения - это приложения, основной функционал которых основан на обмене данными с МоимСкладом по JSON API.
 Для этого при активации приложения по Vendor API на сервер вендора передается [токен доступа к JSON API 1.2](#dostup-po-tokenu-k-json-api) 
 (доступ по токену поддерживается только в JSON API 1.2).
 
Для серверных приложений поддерживается активация и деактивация по Vendor API.

Для серверных приложений доступно получение контекста текущего пользователя МоегоСклада (через Vendor API) - 
 то есть можно узнать, какой именно пользователь какого аккаунта открывает приложение в UI МоегоСклада.

Также серверное приложение может иметь свою вкладку среди iframe-приложений и пользовательский интерфейс. Используя 
 данную возможность можно, например, реализовать управление настройками приложения со стороны пользователя 
 МоегоСклада / администратора аккаунта. Поддерживается возможность расширенного iframe-окна (подробнее см. [дескриптор](#blok-iframe)).
 
 Только для серверных приложений доступны [виджеты](#vidzhety).
 
 В общем случае жесткие требования к внешнему виду / визуальному дизайну iframe-части приложений отсутствуют. 
 Тем не менее, приветствуется визуальное соответствие дизайну МоегоСклада. Для этого мы разработали 
 UI Kit (см. скриншот), который доступен по ссылке [https://github.com/moysklad/html-marketplace-1.0-uikit](https://github.com/moysklad/html-marketplace-1.0-uikit).
 
 
 ![useful image](ui-kit.png)
 
Одновременно на аккаунте может быть подключено несколько серверных приложений.

Доступна отладка на аккаунтах разработчика.


### Iframe-приложения

Iframe-приложение представляет собой веб-приложение, которое загружается по указанному вендором URL в iframe на 
отдельной вкладке/странице внутри UI МоегоСклада.

Iframe-приложения просты в разработке и размещении на площадке МоегоСклада, однако такие приложения тоже должны 
соответствовать [требованиям к приложениям](#trebowaniq-k-prilozheniqm).

Для iframe-приложений поддерживается доступ к контексту пользователя и расширение окна iframe, однако **не поддерживается** 
активация и деактивация по Vendor API, а также доступ по токену к JSON API 1.2. 

При построении пользовательского интерфейса в iframe-приложениях также желательно использовать [UI Kit МоегоСклада](https://github.com/moysklad/html-marketplace-1.0-uikit).

Одновременно на аккаунте может быть подключено несколько iframe-приложений.

Доступна отладка на аккаунтах разработчика.


### Телефония

Эти приложения представляют собой интеграцию с внешними сервисами телефонии по Phone API: 
[https://online.moysklad.ru/api/phone/1.0/doc/index.html](https://online.moysklad.ru/api/phone/1.0/doc/index.html)

Приложения телефонии на витрине приложений размещаются в блоке “Звонки”.

На текущий момент возможность получения доступа по токену к JSON API у приложений телефонии отсутствует, как и 
возможность активации и деактивации приложений телефонии по Vendor API (в перспективе такая возможность может 
появиться).

Одновременно на аккаунте может быть подключено только одно приложение телефонии.

Доступна отладка на аккаунтах разработчика.

### Интеграция с системами лояльности

API для интеграции МоегоСклада с системами лояльности и внешними сервисами управления скидками: 
[https://dev.moysklad.ru/doc/api/loyalty/1.0](https://dev.moysklad.ru/doc/api/loyalty/1.0)
 
Эти приложения размещаются на витрине в отдельном блоке “Скидки”. 
Одновременно на аккаунте может быть подключено только одно такое приложение.
 
Для отладки можно использовать приложение **Loyalty API** (находится первым в блоке Скидки) либо собственный черновик приложения 
совместно с приложением Касса МоегоСклада (кроме версии для iOS).

### Платные и бесплатные приложения

На текущий момент в Маркетплейсе поддерживаются как бесплатные, так и платные приложения. 

Бесплатные приложения могут быть установлены пользователями на аккаунте вне зависимости от типа подписки (с 
ограничениями на Бесплатном тарифе) и в любом количестве. Пользователю должен быть доступен весь функционал приложения
без дополнительной оплаты.
Вендор может брать оплату с пользователей приложений самостоятельно, только если для работы приложения требуется свой
сервис для учета транзакций (например: отправка смс, телефония и подобные услуги). Конкретный механизм самостоятельного
взимания оплаты и его реализация остается на усмотрение вендора и не рассматривается в данном документе.

Для платных приложений в системе МойСклад на данный момент доступен любой вариант стоимости, кратный 
500 рублям в месяц. Эта оплата взимается с пользователей в виде платной опции в рамках их подписки на МойСклад — "Опции платных приложений", 
поэтому здесь так же, как на подписку, для пользователей применяются скидки за оплату на 3, 6 и 12 месяцев.

Также мы написали для пользователей подробную инструкцию по тому, как устанавливать и оплачивать приложения. Вы можете 
посмотреть ее [здесь](https://support.moysklad.ru/hc/ru/articles/360039880573-%D0%9F%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F). 

Вендор получает 75% от стоимости своих приложений без учета скидок и комиссий. Например, если приложение стоимостью 
500 руб было оплачено на 3 месяца, вендор будет получать  500 * 0,75 = 375 рублей ежемесячно.
 
В дальнейшем возможно изменение доли вендора в ту или иную сторону.

В дальнейшей перспективе будет реализован более гибкий биллинг приложений Маркетплейса, не привязанный в общем случае 
к подписке на МойСклад и в том числе позволяющий устанавливать вендорам произвольную стоимость приложений.

### Пробный период платных приложений

В Маркетплейсе МоегоСклада есть возможность дать пользователям поработать с платным приложением бесплатно некоторое время -
**пробный период**.

**Что важно знать о пробном периоде**: 

+ Пробный период может быть назначен приложению как до публикации, так и после. После публикации пробный период активируется
 только для новых пользователей: им смогут воспользоваться только те, кто еще ни разу не устанавливал приложение.

+ Пробный период можно также изменить или убрать у уже опубликованного приложения. При этом уже установленные экземпляры 
приложений продолжат свою работу с прежним пробным периодом (который был на момент их установки).

+ Длительность пробного периода можно установить от 1 до 14 дней. Когда пробный период завершится, приложение продолжит 
работу платно при наличии "Опций платных приложений" в количестве, требуемом для оплаты приложения.
Если у пользователя не окажется свободных опций — приложение будет приостановлено.

+ Приложения с пробным периодом могут быть установлены на любом тарифе и не зависят от наличия "Опции платных приложений"
 на аккаунте. Однако следует помнить об ограничениях функционала приложений на Бесплатном тарифе (в частности, будут 
 недоступны [вебхуки](#rabota-s-webhukami)).

Приложение с пробным периодом можно создать через [Личный кабинет вендора](#lichnyj-kabinet-wendora).

После публикации добавить, изменить или убрать пробный период вашему приложению может модератор МоегоСклада по запросу. 

### Продление пробного периода

Пробный период может быть продлен для аккаунта МоегоСклада в индивидуальном порядке.

Продлить пробный период можно только один раз на одном аккаунте и только для платного опубликованного приложения.

Стартует такой пробный период по нажатию на кнопку подтверждения и длится ровно то количество дней, 
которое вы указали, но не более 14. 
То есть, предоставленный для продления пробный период не суммируется с количеством дней активного пробного периода 
и может на него накладываться.

Например, для аккаунта, с активным пробным периодом (у которого осталось 5 дней), вы указали пробный период: 
Количество дней - 9 и нажали кнопку **Да, предоставить** 7 сентября в 18:01. 
Если не было ошибок при сохранении, тогда:

+ старт предоставленного для продления пробного периода - 7 сентября в 18:01;
+ конец пробного периода - 16 сентября в 18:01.

Данная функция доступна в списке приложений [личного кабинета Вендора](#prodlenie-probnogo-perioda-platnogo-prilozheniq).
Она позволяет также предоставить пробный период платному приложению без пробного периода.

Предоставление пробного периода недоступно в следующих случаях:

+ Приложение бесплатное или не опубликовано.
+ На аккаунте есть активный пробный период и новый срок окончания будет ранее текущего: уменьшать количество дней пробного периода недопустимо.
+ На аккаунте уже есть активная оплаченная подписка для данного приложения.
+ У приложения на аккаунте уже продлевали пробный период: повторно воспользоваться данной функцией невозможно.

### Изменение стоимости приложения

Доступны следующие действия над приложениями:

+ Перевод бесплатного приложение в платное.
+ Перевод платного приложение в бесплатное.
+ Изменение стоимости платного приложения.

Для **неопубликованных** приложений стоимость и признак платности можно изменять через [Личный кабинет вендора](#lichnyj-kabinet-wendora)

Для **опубликованных** приложений Вендору необходимо обратиться к Администратору (модератору) Маркетплейса МоегоСклада.

При переводе опубликованного бесплатного приложения в платное, ему обязательно **назначается пробный период** 
от 7 до 14 дней. Таким образом пользователи, установившие приложение как бесплатное, смогут ещё 
некоторое время продолжить работу с ним бесплатно и принять решение об оплате.

### Жизненный цикл приложения

На текущий момент для приложения Маркетплейса предусмотрены следующие статусы жизненного цикла:

* **Черновик** (_Draft_) - статус черновика, предназначен для разработки и тестирования, приложение не отображается на витрине
 у пользователей МоегоСклада.
* **Готово, отправлено на модерацию** (_Ready_) - статус готовности, означает, что приложение со стороны вендора готово к 
публикации (далее приложение будет 
промодерировано сотрудниками МоегоСклада и опубликовано), приложение все еще не отображается на витрине у пользователей 
МоегоСклада.
* **Опубликовано** (_Published_) - приложение опубликовано на витрине приложений и доступно к установке пользователями МоегоСклада.
* **Снято с публикации** (_Hidden_) - публикация приложения приостановлена. Приложение в статусе 
Hidden исчезает с витрины, но при этом у его текущих пользователей сохраняется возможность с ним работать. 


Жизненный цикл приложения выглядит следующим образом:

1. Приложение создается в [Личном кабинете вендора](#lichnyj-kabinet-wendora) со статусом Draft. Вендор проверяет и отлаживает работу 
приложения на аккаунте разработчика. По готовности приложения вендор передает его на публикацию, 
статус приложения меняется на Ready.
2. Сотрудники МоегоСклада проверяют приложение и, в случае отсутствия замечаний, публикуют приложение на витрине,
 статус приложения меняется на Published. Приложение становится доступно для установки пользователями МоегоСклада.
3. Пользователи МоегоСклада подключают/устанавливают приложение на свой аккаунт, выполняют его настройку 
(если таковая опция имеется в приложении), пользуются приложением и, если оно становится ненужным, отключают/удаляют 
приложение с аккаунта. 
4. Если по каким-то причинам приложение требуется убрать с витрины приложений, то оно переводится в статус Hidden.
Установленные до этого момента экземпляры приложений на аккаунтах продолжают работать и отображаться на UI МоегоСклада 
до момента удаления приложения самим пользователем.
Для прочих аккаунтов, а также для аккаунтов, удаливших приложение, оно скрывается и установка становится невозможна.
Подобный вариант скрытия сейчас реализован только для бесплатных приложений.

### Прямая ссылка на приложение

Вендоры могут получить прямую ссылку на серверные или iframe приложения. 
Для этого нужно в [Личном кабинете вендора](#lichnyj-kabinet-wendora) перейти в режим 
просмотра или редактирования нужного приложения и найти поле 
**Прямая ссылка на приложение**. Прямую ссылку можно также получить с витрины приложений 
из адресной строки браузера, если открыть карточку приложения на витрине.

При переходе по короткой ссылке открывается витрина с карточкой приложения. 
Если пользователь авторизован - то витрина с карточкой открывается сразу, 
если пользователь не авторизован - то через форму логина/авторизацию.

Если приложение не существует или не доступно на аккаунте пользователя, 
использующего прямую ссылку, по какой-либо из причин (то есть, если приложение не отображается 
на витрине, например, приложение в статусе _Draft_), то, при переходе этим пользователем
по ссылке, открывается витрина и появляется сообщение о том, что приложение не найдено.
Если приложение снято с публикации, но уже установлено некоторыми пользователями, 
то у них оно будет отображаться по ссылке, так же, как и на витрине, 
а у остальных, соответственно, нет. 

Так как витрина приложений доступна только администраторам аккаунтов, то карточка приложения
будет доступна только им.

### Права доступа для приложений

Серверные приложения, которые хотят получить доступ к JSON API, в дескрипторе должны указать желаемый уровень доступа к нему.

На текущий момент приложение может запросить следующие уровни доступа:

* **admin** - соответствует пользовательской роли `Системный администратор`: приложение получит полный доступ ко всем отчетам, сущностям и документам в МоемСкладе.
 Этот уровень в перспективе будет устранен.

* **custom** - соответствует пользовательской роли `Индивидуальная роль`: приложение получит доступ только к указанным в дескрипторе отчетам, сущностям и документам.
 Этот уровень **рекомендуется для использования приложениями**, за исключением тех, которые работают с web-хуками и Задачами.
 
На текущий момент права приложения на аккаунте фиксируются на момент установки приложения и при последующем обновлении дескриптора приложения права приложения на данном аккаунте останутся прежними. 

Следует учитывать это при разработке приложений - то есть что одновременно могут существовать и работать установки приложений с разными правами и, 
надо в том или ином поддерживать работу приложения с несколькими наборами прав. 
Предоставление приложению новых дополнительных прав должно происходить через явное подтверждение пользователем и это будет реализовано в будущем. 
Пока что пользователь может обновить права через переустановку: нужно следить, чтобы при удалении приложения данные аккаунта сохранялись какое-то время. 

Подробнее о ролях пользователей см. в [документации JSON API](https://dev.moysklad.ru/doc/api/remap/1.2/dictionaries/#sushhnosti-sotrudnik-rabota-s-pravami-sotrudnika).

Более подробную информацию о правах доступа для приложений можно найти в разделе [Информация о правах доступа](#blok-access).
